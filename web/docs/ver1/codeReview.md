# 👀 code review

## description
- 기능 단위로 기술합니다.
- 코드를 간단하게 설명합니다.
- html 및 thymeleaf 코드는 생략하고 해당 부분 git 링크를 남깁니다.


## summary
1. 회원 기능
   - 회원 가입
   - 회원 수정
   - 회원 조회
2. 로그인 기능
   - 세션/쿠키/인터셉터
   - 로그인
   - 로그아웃
3. 상품 기능
   - 상품 등록
   - 상품 수정
   - 상품 조회(단일)
   - 상품 조회(내가 등록한 상품)
   - 상품 조회(내가 구매한 상품)
4. 장바구니 기능
   - 장바구니 조회
   - 장바구니 삭제
5. 웹 머니
   - 상품 구매
   - 웹 머니 충전 
6. 홈 화면
   - 판매량 top3 상품
   - 모든 상품
   - 높은 평점의 상품
---

## 1. 회원 기능

### 회원 가입
#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/member/memberForm.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/memberAdd.png?raw=true">

- 회원 가입 페이지 입니다.
- url : /members/add


#### 2. 컨트롤러 부분 (controller)
```java
@Controller
@RequiredArgsConstructor
@RequestMapping("/members")
public class AddMemberController {
    private final MemberRepository memberRepository;

    @GetMapping("/add")
    public String addForm(@ModelAttribute("addMember") AddMemberForm addMember){
        return "member/memberForm";
    }

    @PostMapping("/add")
    public String save(@Valid @ModelAttribute("addMember") AddMemberForm addMember, BindingResult bindingResult){
        Member findMember = memberRepository.find(addMember.getEmail());
        if (findMember != null){
            bindingResult.rejectValue("email","duplicateEmail","중복된 이메일 입니다.");
        }
        if (addMember.getConfirmPassword()!=addMember.getPassword()){
            bindingResult.rejectValue("confirmPassword","confirmPassword","비밀번호가 같지 않습니다.");
        }
        if (bindingResult.hasErrors()){
            return "member/memberForm";
        }
        Member member = new Member(addMember.getName(),addMember.getEmail(),addMember.getPassword());
        memberRepository.save(member);
        return "redirect:/login";
    }
}
```
- url : /members/add 를 처리합니다.
- **get 메서드로 들어오는 /add에선 addForm 메서드가 실행**되며, AddMemberForm에 정의된 데이터 형식을 사용하며 "member/memberForm.html"를 반환한다.
- **post 메서드로 들어오는 /add에선 save 메서드가 실행**되며, 
  - 사용자가 입력한 이메일을 검증하고 검증 실패시 bindingResult에 넣는다.
  - 사용자가 입력한 패스워드와 패스워드 확인의 데이터를 검증하고 검증 실패시 bindingResult에 넣는다.
  - bindingResult에 값이 있을시 다시 member/memberForm.html을 리턴한다.
  - 정상적으로 회원가입이 진행된 경우 /login url 를 리다이렉트 한다.

#### 3. DBInterface(jdbc)
```java
@Data
public class Member {
    private long id;
    @NotBlank
    private String name;
    @NotBlank
    @Pattern(regexp = "^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+.[A-Za-z]{2,6}$", message = "이메일 형식이 올바르지 않습니다.")
    private String email;
    @NotBlank
    @Pattern(regexp = "(?=.*[0-9])(?=.*[a-zA-Z])(?=.*\\W)(?=\\S+$).{8,16}")
    private String password;
    private int money;

    public Member() {
    }

    public Member(String name, String email, String password) {
        this.name = name;
        this.email = email;
        this.password = password;
    }
}
```

- member 객체
  - long id : db에서 자동으로 1씩 증가한다.
  - name : 공백을 허용하지 않는 Notblank 검증을 한다.
  - email : 공백을 허용하지 않고, 이메일 형식인지 검증을 한다.
  - password : 공백을 허용하지 않고, 특수문자,영문자,숫자의 혼합형태인지 검증을한다.
  - money : 회원가입할 시 기본 5000의 값이 들어간다.

```java
    public void save(Member member){
        String sql = "insert into member(member_name,member_email,member_password) values (?,?,?)";

        Connection con = null;
        PreparedStatement pstmt = null;
        try{
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1,member.getName());
            pstmt.setString(2,member.getEmail());
            pstmt.setString(3,member.getPassword());
            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }
```
- domain/member/memberRepository.java 의 save 메서드
  - member 객체를 받으면 멤버객체의 이름, 이메일, 패스워드를 insert쿼리로 날린다.


### 회원 수정

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/member/memberEdit.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/memberEdit.png?raw=true">

- 회원 정보를 수정하는 화면이다.
- url : /member/{memberId}/edit

#### 2. 컨트롤러 부분 (controller)
```java
    @GetMapping("/{memberId}/edit")
    public String memberEdit(@PathVariable Long memberId,
                             Model model){
        Member member = memberRepository.find(memberId);
        AddMemberForm addMember = memberService.editMember(memberId, member);
        model.addAttribute("member",addMember);
        return "member/memberEdit";
    }



    @PostMapping("/{memberId}/edit")
    public String memberEdit(@PathVariable Long memberId,
            @Valid @ModelAttribute("member") AddMemberForm addMember, BindingResult bindingResult
    ){
        addMember.setId(memberId);
        if (bindingResult.hasErrors()){
            return "member/memberEdit";
        }
        if (memberService.isPasswordEqual(addMember)){
            memberService.changeMember(addMember, memberId);
            return "redirect:/member/{memberId}";
        }
        bindingResult.rejectValue("confirmPassword","confirmPassword","비밀번호가 같지 않습니다.");
        return "member/memberEdit";
    }
```

- GET : /member/{memberId}/edit
  - memberEdit 
    - @PathVariable 을 활용하여 url의 memberId를 받아서 현재 회원의 회원 정보를 db에서 찾아 member 객체로 반환받는다.
    - 찾은 member 객체를 AddMemberForm의 객체로 바꾸어 model에 저장한다.
    - member/memberEdit.html을 리턴한다.
- POST : /member/{memberId}/edit
  - memberEdit
    - 사용자가 폼에서 입력한 값을 addMemberForm의 객체로 받아왔다.
    - addMember에는 id가 없음으로 @PathVariable로 사용자의 id를 세팅해준다.
    - bindingresult에 오류가 있을시 memeber/memberEdit을 리턴한다.
    - 서비스 로직을 수행시 ture 일때, /member/{memberId}를 리다이렉트한다.


#### 3. 서비스 부분(service)
```java
    public boolean isPasswordEqual(AddMemberForm addMemberForm) {
        return addMemberForm.getPassword().equals(addMemberForm.getConfirmPassword());
    }
    public boolean isPasswordEqual(PasswordSetForm passwordSetForm) {
        return passwordSetForm.getPassword().equals(passwordSetForm.getConfirmPassword());
    }
```

- service/MemberService.java
  - 패스워드가 같은지 검증한다.

#### 4. DBInterface(jdbc)
```java
    public Member find(Long memberId){
        String sql = "select * from member where member_Id = ?";

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,memberId);
            rs = pstmt.executeQuery();
            if (rs.next()){
                Member member = new Member(
                        rs.getString("member_name"),
                        rs.getString("member_email"),
                        rs.getString("member_password"));
                member.setId(rs.getLong("member_id"));
                member.setMoney(rs.getInt("member_money"));
                return member;
            }else {
                throw new NoSuchFieldException("member not found memberId = "+ memberId);
            }
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }
    }
    
    public void update(Member member){
        String sql = "update member set (member_name, member_email, member_password) = (?,?,?) where member_id=?";

        Connection con = null;
        PreparedStatement pstmt = null;
        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1,member.getName());
            pstmt.setString(2,member.getEmail());
            pstmt.setString(3,member.getPassword());
            pstmt.setLong(4,member.getId());

            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }
```
- domain/member/memberRepository.java 의 find(Long **memberId**) 메서드
  - memberId를 받으면 "select * from member where member_Id = **memberId**" 쿼리를 날려서 멤버객체로 가져온다.
- domain/member/memberRepository.java 의 update(Member member) 메서드
  - member 객체를 받으면 멤버객체의 이름, 이메일, 패스워드를 update 쿼리로 날린다.


### 회원조회

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/member/member.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/member.png?raw=true">

- 멤버 정보를 조회할때 보이는 페이지
- URL : /member/{memberId}

#### 2. 컨트롤러 부분 (controller)
```java
    @GetMapping("/{memberId}")
    public String member(@PathVariable Long memberId, Model model){
        Member findMember = memberRepository.find(memberId);
        model.addAttribute("member",findMember);
        return "member/member";
    }
```
- GET : /member/{memberId}
  - memberId 로 memberRepository에서 멤버를 찾아서 모델에 저장한다.
  - member/member.html을 리턴한다.

#### 3. DBInterface(jdbc)
```java
    public Member find(String memberEmail){
        String sql = "select * from member where member_email = ?";

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1,memberEmail);
            rs = pstmt.executeQuery();
            if (rs.next()){
                Member member = new Member(
                        rs.getString("member_name"),
                        rs.getString("member_email"),
                        rs.getString("member_password"));
                member.setId(rs.getLong("member_id"));
                member.setMoney(rs.getInt("member_money"));
                return member;
            }else {
                throw new NoSuchFieldException("member not found memberEmail = "+ memberEmail);
            }
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }

    }

    public Member find(Long memberId){
        String sql = "select * from member where member_Id = ?";

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,memberId);
            rs = pstmt.executeQuery();
            if (rs.next()){
                Member member = new Member(
                        rs.getString("member_name"),
                        rs.getString("member_email"),
                        rs.getString("member_password"));
                member.setId(rs.getLong("member_id"));
                member.setMoney(rs.getInt("member_money"));
                return member;
            }else {
                throw new NoSuchFieldException("member not found memberId = "+ memberId);
            }
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }
    }
```
- find(memberId) : memberId로 RDB에서 데이터를 가져와 Member 객체로 가져온다.
- find(memberEmail) : memberEmail이 중복가입이 안되기 때문에 Email이 key가 될 수 있다. 이후 코드는 상동

---

## 2. 로그인 기능

### 세션/쿠키, 스프링 인터셉터

#### 세션/쿠키
- 서블릿 request의 Session을 활용한다. 

#### 인터셉터 

```java
@Slf4j
public class LoginCheckInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {

        String requestURI = request.getRequestURI();
        log.info("인증 체크 인터셉터 실행 {}", requestURI);

        HttpSession session = request.getSession();
        if (session==null || session.getAttribute(LOGIN_MEMBER)==null){
            log.info("미인증 사용자 요청");
            response.sendRedirect("/login?redirectURL="+requestURI);
            return false;
        }
        return true;
    }
}
```
- 스프링의 인터셉터를 활용하여 로그인안되어 있을시(세션에 정보가 없을시) home으로 렌더하는 인터셉터를 구현했다.

#### webConfig : annotation Resolvers, addInterceptors를 만들어준다.
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addArgumentResolvers(List<HandlerMethodArgumentResolver> resolvers) {
        resolvers.add(new LoginMemberArgumentResolver());
    }

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new LogInterceptor())
                .order(1)
                .addPathPatterns("/**")
                .excludePathPatterns("/css/**","/*.ico","/error");
        registry.addInterceptor(new LoginCheckInterceptor())
                .order(2)
                .addPathPatterns("/**")
                .excludePathPatterns("/css/**","/*.ico","/members/add","/login","/logout","/error","/*","/member/find/**");
    }
}
```
- 내가 만든 어노테이션과 인터셉터를 스프링 컨텍스트에 설정해준다. 

#### @Login annotaion : 커스텀 로그인 annotaion

```java
@Target(ElementType.PARAMETER)
@Retention(RetentionPolicy.RUNTIME)
public @interface Login {}
```
type 설정 및 retention 설정을 해주었다.

```java
@Slf4j
public class LoginMemberArgumentResolver implements HandlerMethodArgumentResolver {
    @Override
    public boolean supportsParameter(MethodParameter parameter) {
        log.info("supportsParameter 실행");
        boolean hasLoginAnnotation = parameter.hasParameterAnnotation(Login.class);
        boolean hasMemberType = Member.class.isAssignableFrom(parameter.getParameterType());
        log.debug("hasLoginAnnotation={}",hasLoginAnnotation);
        log.debug("hasMemberType={}",hasMemberType);
        return hasMemberType && hasLoginAnnotation;
    }

    @Override
    public Object resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory) throws Exception {
        log.info("resolveArgument 실행");
        HttpServletRequest request = (HttpServletRequest) webRequest.getNativeRequest();
        log.debug("webRequest.getNativeRequest()={}",webRequest.getNativeRequest());
        HttpSession session = request.getSession(false);
        log.debug("session={}",session);
        if (session==null){
            return null;
        }
        log.debug("session.getAttribute(LOGIN_MEMBER)={}",session.getAttribute(LOGIN_MEMBER));
        return session.getAttribute(LOGIN_MEMBER);
    }
}
```
- 파라미터가 member 및 Login 어노테이션 클래스 일때 실행된다.
- request에서 세션정보를 가져왔을시 세션이 없다면 null을 리턴하고 있을시 세션정보를 리턴한다.

### 로그인/로그아웃


#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/member/memberForm.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/loginForm.png?raw=true">


#### 2. 컨트롤러 부분 (controller)
```java
@Controller
@RequiredArgsConstructor
@Slf4j
public class LoginController {

    private final LoginService loginService;

    @GetMapping("/login")
    public String loginForm(@ModelAttribute("loginForm") LoginForm loginForm) {
        return "login/loginForm";
    }
    @PostMapping("/login")
    public String login(@Valid @ModelAttribute("loginForm") LoginForm loginForm,
                        BindingResult bindingResult,
                        @RequestParam(defaultValue = "/") String redirectURL,
                        HttpServletRequest request){
        if (bindingResult.hasErrors()){
            return "login/loginForm";
        }

        Member loginMember = loginService.login(loginForm.getEmail(), loginForm.getPassword());
        log.debug("loginMember={}",loginMember);
        if (loginMember == null){
            bindingResult.reject("loginFail","아이디 또는 비밀번호가 맞지 않습니다.");
            return "login/loginForm";
        }
        HttpSession session = request.getSession();
        session.setAttribute(LOGIN_MEMBER,loginMember);

        return "redirect:"+redirectURL;
    }
    
    @PostMapping("/logout")
    public String logout(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session!=null){
            session.invalidate();
        }
        return "redirect:/";
    }
}
```
- GET : /login
  - LoginForm을 modelAttribute로 담아서 login/loginForm.html을 리턴한다.
- POST : /login
  - bindingResult에 에러가 있으면 login/loginForm (<- 오류정보가 표시된다)을 바로 리턴한다.
  - loginService.login을 수행후 loginMember 가 null일시 bindingResult에 오류를 담고 login/loginForm을 리턴한다.
  - 로그인 서비스 성공시 세션에 담고 기존에 접근하려 했던 URL을 리다이렉트 해준다.
- POST : /logout
  - 현재 존재하는 세션을 찾아서 세션을 종료시킨다. 이후 홈화면으로 리다이렉트 한다.
  
#### 3. 서비스 부분(service)
```java
@Slf4j
@Service
public class LoginService {
    private final MemberRepository memberRepository;
    public LoginService(MemberRepository memberRepository){
        this.memberRepository = memberRepository;
    }
    public Member login(String loginEmail, String password){
        Member member = memberRepository.find(loginEmail);
        if (member!=null&&member.getPassword().equals(password)){
            log.debug("[member={}][input password={}]",member,password);
            return member;
        }
        return null;
    }
}
```
- login 메서드
  - email 과 패스워드를 입력 받는다.
  - email로 email에 해당하는 멤버의 정보를 가져온다.
  - 해당 멤버의 패스워드와 입력한 패스워드가 같을 시 찾은 멤버를 반환한다.
  - 같지 않을시 null을 리턴한다.

---

## 3. 상품 기능

### 상품 등록

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/item/itemAdd.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/itemAdd.png?raw=true">

- 상품을 등록하는 화면이다.
- url : /item/items/{memberId}/add

#### 2. 컨트롤러 부분 (controller)
```java
    @GetMapping("/items/{memberId}/add")
    public String addItem(@ModelAttribute("addItemForm") AddItemForm addItemForm,
                          @PathVariable Long memberId){
        return "item/itemAdd";
    }
    @PostMapping("/items/{memberId}/add")
    public String addItem(@ModelAttribute("addItemForm") AddItemForm addItemForm,
                          BindingResult bindingResult,
                          @PathVariable Long memberId){
        if (bindingResult.hasErrors()){
            return "item/itemAdd";
        }
        if (itemRepository.findByItemName(addItemForm.getItemName())!=null){
            bindingResult.rejectValue("itemName","itemName","중복된 상품명이 있습니다. 다른 상품명을 등록하십시오");
            return "item/itemAdd";
        }
        Item addItem = new Item(memberId,
                addItemForm.getItemName(),
                addItemForm.getPrice(),
                addItemForm.getQuantity(),
                addItemForm.getDescription());
        itemRepository.save(addItem);
        return "redirect:/item/items/{memberId}";
    }
```
- GET : /item/items/{memberId}/add
  - addItemForm과 memberId를 itemAdd.html에 넘긴뒤 item/itemAdd.html을 리턴한다.
- POST : /item/items/{memberId}/add
  - addItemForm에 들어온 데이터를 확인한다.
  - 검증 뒤 이상이 없으면 Item 객체로 변환후 itemRepository.save 메서드로 rdb에 저장한다.
  - 이후 item/items/{memberId}를 리턴한다.

#### 3. DTO 부분 (DTO)
```java
@Data
public class AddItemForm {
    @NotNull
    String itemName;
    @NotNull
    @Range(min = 1000, max = 1000000)
    private Integer price;
    @NotNull
    @Range(min = 1, max = 10000)
    private Integer quantity;
    private String description;

    public AddItemForm(String itemName, Integer price, Integer quantity, String description) {
        this.itemName = itemName;
        this.price = price;
        this.quantity = quantity;
        this.description = description;
    }
}
```
- itemName : 공백을 허용하지 않는다.
- price : 공백을 허용하지 않고 1000~1000000 사이의 값만 받는다.
- quantity : 공백을 허용하지 않고 1 ~ 10000 사이의 값만 받는다.
- description : 검증 x

#### 4. DBInterface(jdbc)
```java
@Data
public class Item {
    private Long itemId;
    private Long sellerId;
    private String name;
    private Integer price;
    private Integer quantity;
    private String description;
    private Integer salesRate;

    public Item() {
    }

    public Item(Long sellerId, String name, Integer price, Integer quantity, String description) {
        this.sellerId = sellerId;
        this.name = name;
        this.price = price;
        this.quantity = quantity;
        this.description = description;
    }
}
```
- item 객체
  - itemId = 아이템 아이디 (db에 저장시 자동 증가)
  - sellerId = 판매자 회원 아이디 
  - name = 상품 이름
  - price = 상품 가격
  - quantity = 상품 수량
  - description = 상품 설명
  - salesRate = 상품 판매량

```java
public void save(Item item){
        String sql = "insert into Item(seller_id,item_name,item_price,item_quantity,item_description) values (?,?,?,?,?)";

        Connection con = null;
        PreparedStatement pstmt = null;
        try{
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,item.getSellerId());
            pstmt.setString(2,item.getName());
            pstmt.setInt(3,item.getPrice());
            pstmt.setInt(4,item.getQuantity());
            pstmt.setString(5,item.getDescription());
            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }
```

- domain/item/itemRepository 
  - save 매서드 
    - item 객체를 받아서 insert 쿼리를 날려서 RDB에 저장한다. 
    - insert into Item(seller_id,item_name,item_price,item_quantity,item_description) values (?,?,?,?,?)

### 상품 수정

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/itemEdit/itemEdit.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/itemEdit.png?raw=true">

- 상품 정보를 수정하는 화면이다.
- url : /item/{memeberId}/{itemId}/edit

#### 2. 컨트롤러 부분 (controller)
```java
    @GetMapping("/{memberId}/{itemId}/edit")
    public String editItem(@ModelAttribute("addItemForm") AddItemForm addItemForm,
                           @PathVariable Long memberId,
                           @PathVariable Long itemId,
                           Model model){
        Item item = itemRepository.find(itemId);
        addItemForm.setItemName(item.getName());
        addItemForm.setPrice(item.getPrice());
        addItemForm.setQuantity(item.getQuantity());
        addItemForm.setDescription(item.getDescription());
        model.addAttribute("addItemForm",addItemForm);
        return "item/itemEdit";
    }
    @PostMapping("/{memberId}/{itemId}/edit")
    public String editItem(@ModelAttribute("addItemForm") AddItemForm addItemForm,
                           BindingResult bindingResult,
                           @PathVariable Long itemId,
                           @PathVariable Long memberId){
        if (bindingResult.hasErrors()){
            return "item/itemEdit";
        }

        Item updateItem = itemRepository.find(itemId);
        updateItem.setName(addItemForm.getItemName());
        updateItem.setPrice(addItemForm.getPrice());
        updateItem.setQuantity(addItemForm.getQuantity());
        updateItem.setDescription(addItemForm.getDescription());
        itemRepository.update(updateItem);
        return "redirect:/item/items/{memberId}";
    }
```
- GET : /item/{memberId}/{itemId}/edit
  - itemId으로 item 정보를 가져온 뒤 addItemForm에 정보를 html에 넘겨준뒤 item/itemEdit.html을 리턴한다.
  - 수정시 기존 데이터를 보여주고 싶기 때문에 찾아서 데이터를 넘겨주었다.
- POST : /item/{memberId}/{itemId}/edit
  - bindingResult에 에러가 있으면 item/itemEdit.html을 리턴한다.
  - 수정 할 item을 itemRepository에서 찾은뒤 addItemForm에 들어온 데이터로 바꾸어준다.
  - 이후 update 한뒤 /item/items/{memberId}로 리다이렉트한다.



#### 3. DBInterface(jdbc)
```java

    public void update(Item item){
        String sql = "update item set (item_name,item_price,item_quantity,item_description,salesrate) = (?,?,?,?,?) where item_id=?";

        Connection con = null;
        PreparedStatement pstmt = null;
        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1,item.getName());
            pstmt.setInt(2,item.getPrice());
            pstmt.setInt(3,item.getQuantity());
            pstmt.setString(4,item.getDescription());
            pstmt.setInt(5,item.getSalesRate());
            pstmt.setLong(6,item.getItemId());

            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }

```

- update(Item item)
  - item 객체(수정된 객체)를 받아서 해당 itemId에 update쿼리를 날려준다.
    ```sql
    update item 
            set (item_name,item_price,item_quantity,item_description,salesrate) = (?,?,?,?,?)
                where item_id=?(item.getItemId())
    ```

### 상품 조회(단일)

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/item/item.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/item.png?raw=true">

- 상품 정보를 조회하는 화면이다.
- url : /item/{itemId}

#### 2. 컨트롤러 부분 (controller)
```java
    @GetMapping("/{itemId}")
    public String item(@PathVariable Long itemId, Model model, HttpServletRequest request){
        Item item = itemRepository.find(itemId);
        HttpSession session = request.getSession();
        Member member = (Member)session.getAttribute(SessionConst.LOGIN_MEMBER);
        model.addAttribute("member",member);
        model.addAttribute("item",item);
        return "item/item";
    }
```
- GET : /item/{itemId}
  - itemId를 통해 item 객체를 itemRepository에서 가져온다.
  - 세션에서 현재 로그인된 멤버객체를 가져온다.
  - 모델에 멤버와 아이템을 담고 item/item.html을 리턴한다.


#### 3. DBInterface(jdbc)
```java
    public Item find(Long itemId){
        String sql = "select * from item where item_Id = ?";

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,itemId);
            rs = pstmt.executeQuery();
            if (rs.next()){
                Item item = new Item(
                        rs.getLong("seller_id"),
                        rs.getString("item_name"),
                        rs.getInt("item_price"),
                        rs.getInt("item_quantity"),
                        rs.getString("item_description"));
                item.setItemId(itemId);
                item.setSalesRate(rs.getInt("salesrate"));
                return item;
            }else {
                throw new NoSuchFieldException("item table not found itemId = "+ itemId);
            }
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }
    }
```
- find(Long itemId)
  - itemId에 해당하는 item table에서 데이터를 가져와서 ITEM 객체로 바꾸어 리턴한다.
    ```sql
      select * from item where item_Id = ? (itemID)
    ```

  

### 상품 조회(내가 등록한 상품 리스트)

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/item/registerItems.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/registerItems.png?raw=true">

- 내가 등록한 상품 목록을 보여주는 화면이다. (상품 등록, 수정에 접근할 수 있음)
- url : /item/items/{memberId}

#### 2. 컨트롤러 부분 (controller)
```java
    @GetMapping("/items/{memberId}")
    public String registeredItems(@PathVariable Long memberId, Model model){
        List<Item> registerItems = itemRepository.findBySellerId(memberId);
        if (registerItems==null){
            //등록 상품이 없을때 처리
            return "redirect:/";
        }
        model.addAttribute("registerItems",registerItems);
        return "item/registerItems";
    }
```

- GET : /item/items/{memberId}
  - memberId로 itemRepository에 저장된 모든 리스트를 가져온다.
  - 만약 registerItem이 없다면 홈으로 redirect를 한다.
    - 수정 필요하다. 등록을하려면 registerItems.html에 접근해야하는데 접근하지 못한다.
  - model에 찾은 리스트를 넘기고 registerItems.html을 리턴한다.


#### 3. DBInterface(jdbc)
```java
    public List<Item> findBySellerId(Long memberId){
        String sql = "select * from item where seller_id = ?";
        List<Item> itemList = new ArrayList<>();

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,memberId);
            rs = pstmt.executeQuery();
            while (rs.next()){
                Item item = new Item(
                        rs.getLong("seller_id"),
                        rs.getString("item_name"),
                        rs.getInt("item_price"),
                        rs.getInt("item_quantity"),
                        rs.getString("item_description"));
                item.setItemId(rs.getLong("item_id"));
                item.setSalesRate(rs.getInt("salesrate"));
                log.debug("itemRepo findByMemberId item={}",item);
                itemList.add(item);
                if (rs.isLast()){
                    log.debug("itemRepo findByMemberId itemList={}",itemList);
                    return itemList;
                }
            }
            throw new NoSuchFieldException();
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }
    }

```
- findBySellerId(Long memberId)
  - item 테이블에서 seller_id 가 memberId인 모든 컬럼을 가져와서 List<item>형태로 리턴한다. 만약 없다면 예외를 터트리고 바로 잡아서 null처리한다.
    ```sql
      select * from item where seller_id = ? (memberId)
    ```




### 상품 조회(내가 구매한 상품 리스트)

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/item/purchaseList.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/purchaseList.png?raw=true">

- 이제까지 구매한 상품목록을 보여주는 화면이다.
- url : /item/shoplist/{memberId}

#### 2. 컨트롤러 부분 (controller)
```java
    @GetMapping("/shoplist/{memberId}")
    public String shopList(@PathVariable Long memberId, Model model){
        List<Item> shopList = reviewRepository.findByMemberId(memberId);
        if (shopList==null){
            return "redirect:/";
        }
        model.addAttribute("shopList",shopList);
        return "item/purchaseList";
    }
```

- GET : /item/shoplist/{memberId}
  - memberId로 reviewRepository에서 findByMemberId 메서드를 통해 List<item>을 반환받는다.
    - list가 null일시 homepage로 리다이렉트한다.
    - 모델에 리스트를 담아서 item/purchaselist.html 을 리턴한다.


#### 3. DBInterface(jdbc)
```java
    public List<Item> findByMemberId(Long memberId){
        String sql = "select * from Item LEFT JOIN Review ON Item.item_id = Review.item_id where Review.buyer_id = ?";
        List<Item> itemList = new ArrayList<>();

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,memberId);
            rs = pstmt.executeQuery();
            while (rs.next()){
                Item item = new Item(
                        rs.getLong("seller_id"),
                        rs.getString("item_name"),
                        rs.getInt("item_price"),
                        rs.getInt("item_quantity"),
                        rs.getString("item_description"));
                item.setItemId(rs.getLong("item_id"));
                log.debug("itemRepo findByMemberId item={}",item);
                itemList.add(item);
                if (rs.isLast()){
                    log.debug("itemRepo findByMemberId itemList={}",itemList);
                    return itemList;
                }
            }
            throw new NoSuchFieldException();
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }
    }
```
**reviewRepository**
- findByMemberId(Long memberId)
  - join 연산을 통해 review table에 buyer_id=memberId 인 item table의 컬럼을 가져와서 list<item>의 객체로 반환한다.
    ```sql
      select * from Item LEFT JOIN Review ON Item.item_id = Review.item_id where Review.buyer_id = ?
    ```


---

## 4. 장바구니 기능

### 장바구니 조회

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/member/basket.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/basket.png?raw=true">

- 장바구니에 넣은 목록을 조회하는 화면이다.
- url : /item/basket/{memberId}

#### 2. 컨트롤러 부분 (controller)
```java
    @GetMapping("/{memberId}")
    public String basket(@PathVariable Long memberId, Model model,
                         @ModelAttribute("basketForm")BasketForm basketForm){
        List<Item> basketItems = basketRepository.findByMemberId(memberId);
        model.addAttribute("basketItems",basketItems);
        return "/item/basket";
    }
```

- GET : /item/basket/{memberId}
  - memberId를 통해 basketRepository에서 basketItems 리스트를 받아서 /item/basket.html를 리턴한다.

#### 3. DTO
```java
@Data
public class BasketForm {
    private String[] basketItemIds;
}
```
- 체크 박스가 체크된 item을 서버단(controller)로 받고 싶기 때문에 String 배열로 선언하여 문자 id리스트를 받아온다.
#### 4. DBInterface(jdbc)
```java
    public List<Item> findByMemberId(Long memberId){
        String sql = "select * from Item LEFT JOIN Basket ON Item.item_id = Basket.item_id where Basket.member_id = ?";
        List<Item> itemList = new ArrayList<>();

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,memberId);
            rs = pstmt.executeQuery();
            while (rs.next()){
                Item item = new Item(
                        rs.getLong("member_id"),
                        rs.getString("item_name"),
                        rs.getInt("item_price"),
                        rs.getInt("item_quantity"),
                        rs.getString("item_description"));
                item.setItemId(rs.getLong("item_id"));
                log.debug("itemRepo findByMemberId item={}",item);
                itemList.add(item);
                if (rs.isLast()){
                    log.debug("itemRepo findByMemberId itemList={}",itemList);
                    return itemList;
                }
            }
            throw new NoSuchFieldException();
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }
    }

```
**basketRepository**
- findByMemberId(Long memberId)
  - item 테이블과 basket 테이블 을 조인 하여 basket이 memberId인 item 컬럼들을 가져와서 list<item>의 객체로 리턴한다.
    ```sql
      select * from Item LEFT JOIN Basket ON Item.item_id = Basket.item_id where Basket.member_id = ?
    ```

### 장바구니 등록

#### 1. 컨트롤러 부분 (controller)
```java
    @GetMapping("/item/basket/{memberId}/{itemId}/add")
    public String addBasket(@PathVariable("memberId") Long memberId,
                            @PathVariable("itemId") Long itemId){
        if (basketRepository.find(itemId,memberId)!=null){
            return "redirect:/";
        }
        basketRepository.addBasket(itemId,memberId);
        return "redirect:/item/basket/{memberId}";
    }
```

- GET : /item/basket/{memberId}/{itemId}/add
  - 이미 장바구니에 담겨있는 아이템은 담아지지 않게하기 위해서 itemId,memberId 로 찾아지는 아이템이 있을경우는 홈화면으로 리다이렉트한다.
  - 장바구니 레포지토리에 추가하고 /item/basket/{memberId}(내 장바구니 목록)으로 리다이렉트 한다

#### 2. DBInterface(jdbc)
```java
    public void addBasket(Long itemId, Long memberId){
        String sql = "insert into Basket(member_id,item_id) values (?,?)";

        Connection con = null;
        PreparedStatement pstmt = null;
        try{
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,memberId);
            pstmt.setLong(2,itemId);
            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }
```
**basketRepository**
- addBasket(Long itemId, Long memberId)
  - itemId, memberId 를 받아서 insert 쿼리를 날린다.
    ```sql
      insert into Basket(member_id,item_id) values (?,?)
    ```


### 장바구니 삭제

#### 1. 컨트롤러 부분 (controller)
```java
    @PostMapping("/{memberId}/basket")
    public String outBasket(@ModelAttribute("basketForm") BasketForm basketForm, BindingResult  bindingResult,
                            @PathVariable Long memberId){
        if (basketForm.getBasketItemIds().length==0){
            bindingResult.reject("NoCheckItem",null,"아무것도 체크하지 않았습니다.");
        }
        for (String StringId : basketForm.getBasketItemIds()) {
            long itemId = Long.parseLong(StringId);
            basketRepository.delete(itemId,memberId);
        }
        return "redirect:/item/basket/{memberId}";
    }
```

- POST : /item/basket/{memberId}/basket
  - basketForm에서 체크된 아이템을 가져온다. string 배열인 ids를 가져와서 itemid,memberId를 basketRepository 에서 삭제한다. 

#### 2. DBInterface(jdbc)
```java
    public void delete(Long itemId, Long memberId){
        String sql = "delete from basket where member_id=? and item_id=?;";
        Connection con = null;
        PreparedStatement pstmt = null;
        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,memberId);
            pstmt.setLong(2,itemId);
            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con, pstmt, null);
        }
    }
```
**basketRepository**
- delete(Long itemId, Long memberId)
  - basket 테이블에서 member_id = memberId, item_id = itemId 인 값을 delete한다.
    ```sql
      delete from basket where member_id=? and item_id=?;
    ```

### 장바구니 구매


#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/item/purchase.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/purchase.png?raw=true">

- 회원 정보를 수정하는 화면이다.
- url : /item/basket/{memberId}/purchase

#### 2. 컨트롤러 부분 (controller)
```java
    @PostMapping("/{memberId}/purchase")
    public String purchase(@ModelAttribute("basketForm") BasketForm basketForm,
                           @ModelAttribute("purchaseForm") PurchaseForm purchaseForm,
                           @PathVariable Long memberId,
                           Model model
                           ){
        List<Item> purchaseList = new ArrayList<>();
        Integer resultPrice = 0;
        for (String StringId : basketForm.getBasketItemIds()) {
            long itemId = Long.parseLong(StringId);
            Item item = itemRepository.find(itemId);
            resultPrice = resultPrice + item.getPrice();
            purchaseList.add(item);
        }
        if (purchaseList==null){
            return "redirect:/item/basket/{memberId}";
        }
        model.addAttribute("purchaseList",purchaseList);
        purchaseForm.setResultPrice(resultPrice);
        purchaseForm.setPurchaseItemIds(basketForm.getBasketItemIds());
        return "/item/purchase";
    }
```

- POST :  /item/basket/{memberId}/purchase
  - basketForm에 들어온 ids를 통해 item을 찾는다.
  - 모든 item의 가격을 더한 후 PurchaseForm의 resultPrice에 저장한다.
  - getBasketItemIds를 PurchaseForm의 purchaseItemIds에 저장한다.
  - 모델에 purchaseList를 담는다.
  - /item/purchase.html을 리턴한다.

#### 3. DTO
```java
@Data
public class PurchaseForm {
    String[] purchaseItemIds;
    Integer resultPrice;
}
```
- purchaseItemIds : 장바구니에서 체크된 목록을 그대로 받아오기 위해서 string[]로 선언한다.
- resultPrice : 모든 아이템의 총 가격을 보여주기위한 변수이다.

---

## 5. 웹 머니 기능

### 상품 구매 프로세스

#### 1. 컨트롤러 부분 (controller)
```java
@Slf4j
@Controller
@RequiredArgsConstructor
@RequestMapping("/item/purchase")
public class PurchaseController {
    private final ItemRepository itemRepository;
    private final ReviewRepository reviewRepository;
    private final MemberRepository memberRepository;
    private final BasketRepository basketRepository;

    @GetMapping("/{memberId}/{itemId}")
    public String purchasePage(
            @ModelAttribute("purchaseForm") PurchaseForm purchaseForm,
            @PathVariable Long itemId,
            @PathVariable Long memberId,
            Model model
    ){
        Item item = itemRepository.find(itemId);
        List<Item> purchaseList = new ArrayList<>();
        purchaseList.add(item);
        model.addAttribute("purchaseList",purchaseList);

        String[] ids = new String[1];
        ids[0] = String.valueOf(itemId);
        purchaseForm.setPurchaseItemIds(ids);
        purchaseForm.setResultPrice(item.getPrice());
        return "/item/purchase";
    }

    @PostMapping("/{memberId}")
    public String purchase(
            @ModelAttribute("purchaseForm") PurchaseForm purchaseForm,
            BindingResult bindingResult,
            @PathVariable Long memberId
    ){
        Member member = memberRepository.find(memberId);
        String[] purchaseItemIds = purchaseForm.getPurchaseItemIds();
        if (purchaseItemIds==null){
            bindingResult.reject("purchaseItemIds","구매 아이템이 없습니다.");
        }
        if (purchaseForm.getResultPrice()>member.getMoney()){
            bindingResult.rejectValue("resultPrice","resultPrice","게임 머니가 부족합니다. 충전이 필요합니다.");
        }
        if (bindingResult.hasErrors()){
            return "/item/purchase";
        }


        //service
        for (String itemId : purchaseItemIds) {
            long id = Long.parseLong(itemId);
            Item item = itemRepository.find(id);
            if (item.getQuantity()==0){
                bindingResult.reject("noItem",null,"사려고 하는 물품 중에 재고가 없는 물건이 있습니다.");
                return "/item/purchase";
            }
            Member sellerMember = memberRepository.find(item.getSellerId());
            sellerMember.setMoney(sellerMember.getMoney()+item.getPrice());
            member.setMoney(member.getMoney()-item.getPrice());
            memberRepository.updateMoney(sellerMember);
            memberRepository.updateMoney(member);
            Integer salesRate = item.getSalesRate() + 1;
            int quantity = item.getQuantity() - 1;
            item.setQuantity(quantity);
            item.setSalesRate(salesRate);
            itemRepository.update(item);
            reviewRepository.addPurchaseList(item.getItemId(),memberId);
            basketRepository.delete(item.getItemId(),memberId);


        }
        return "redirect:/item/shoplist/{memberId}";

    }
}
```

- GET : /item/purchase/{memberId}/{itemId}
  - purchase.html에서 PurchaseForm가 필요하기 때문에 itemId를 string[]로 담아서 PurchaseForm으로 저장한다.
- POST : /item/purchase/{memberId}
  - memberId를 통해 member를 찾는다.
  - purchaseForm.getPurchaseItemIds() null일때 bindingresult에 오류를 저장한다.
  - 서비스 로직을 수행한 뒤 /item/shoplist/{memberId}(구매 목록)을 리다이렉트한다.
  
#### 3. 서비스 부분(service)
```java
        for (String itemId : purchaseItemIds) {
            long id = Long.parseLong(itemId);
            Item item = itemRepository.find(id);
            if (item.getQuantity()==0){
                bindingResult.reject("noItem",null,"사려고 하는 물품 중에 재고가 없는 물건이 있습니다.");
                return "/item/purchase";
            }
            Member sellerMember = memberRepository.find(item.getSellerId());
            sellerMember.setMoney(sellerMember.getMoney()+item.getPrice());
            member.setMoney(member.getMoney()-item.getPrice());
            memberRepository.updateMoney(sellerMember);
            memberRepository.updateMoney(member);
            Integer salesRate = item.getSalesRate() + 1;
            int quantity = item.getQuantity() - 1;
            item.setQuantity(quantity);
            item.setSalesRate(salesRate);
            itemRepository.update(item);
            reviewRepository.addPurchaseList(item.getItemId(),memberId);
            basketRepository.delete(item.getItemId(),memberId);
```
1. item에서 판매자 id를 가져와서 판매자 member 객체를 가져온다.
2. 이후 판매자 member.money에 아이템가격을 더한다.
3. 구매자 member.money에는 아이템 가격을 뺀다.
4. 두 맴버 객체 다 memberRepository에서 update를 해준다.
5. item의 salesReate(판매량)을 1 올린다.
6. item의 quantity를 1 내린다.
7. itemRepository에서 update해준다.
8. reviewRepository에 add 해준다. (아이템id,구매자id)
9. 장바구니 목록에서 삭제한다.

### 웹 머니 충전

#### 1. 충전 팝업을 뛰운뒤 진행 프로세스


<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/money1.png?raw=true">
<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/money2.png?raw=true">
<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/money3.png?raw=true">
<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/money4.png?raw=true">
<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/money5.png?raw=true">

- 회원 정보에서 웹 머니 충전 팝업을 뛰운뒤 진행된다..

#### 2. 컨트롤러 부분 (controller)
```java
    @GetMapping("/charge/verify/{memberId}")
    public String chargeVerify(@ModelAttribute("findMember") FindMemberForm findMemberForm){
        return "member/charge/cashVerify";
    }
    @PostMapping("/charge/verify/{memberId}")
    public String chargeVerify(@Valid @ModelAttribute("findMember") FindMemberForm findMemberForm,
                               BindingResult bindingResult,
                               @PathVariable Long memberId,
                               Model model
                               ){
        if (bindingResult.hasErrors()){
            return "member/charge/cashVerify";
        }

        Member member = memberRepository.find(memberId);

        if (member!=null&&memberService.isMember(findMemberForm, member)){
            //성공로직
            model.addAttribute("member",member);
            return "member/charge/verifyDone";
        }
        //실패로직
        bindingResult.rejectValue("email","emailError","해당 정보와 일치하는 회원 정보가 없습니다.");
        return "member/charge/cashVerify";
    }
    @GetMapping("/charge/input/{memberId}")
    public String chargeInput(@ModelAttribute("inputMoney")ChargeCashForm cashForm,
                              @PathVariable Long memberId, Model model){
        Member member = memberRepository.find(memberId);
        model.addAttribute("member",member);
        return "member/charge/cashCharge";
    }
    @PostMapping("/charge/input/{memberId}")
    public String chargeInput(@Valid @ModelAttribute("inputMoney")ChargeCashForm cashForm, BindingResult bindingResult,
                              @PathVariable Long memberId, Model model){
        Member member = memberRepository.find(memberId);
        if (bindingResult.hasErrors()){
            model.addAttribute("member",member);
            return "member/charge/cashCharge";
        }
        Member updateMember = memberService.chargeCash(member, cashForm);
        memberRepository.updateMoney(updateMember);
        return "member/charge/chargeDone";
    }
```
#### 3. DBInterface(jdbc)
```java
    public void update(Member member){
        String sql = "update member set (member_name, member_email, member_password) = (?,?,?) where member_id=?";

        Connection con = null;
        PreparedStatement pstmt = null;
        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1,member.getName());
            pstmt.setString(2,member.getEmail());
            pstmt.setString(3,member.getPassword());
            pstmt.setLong(4,member.getId());

            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }
```

## 6. 홈 화면

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/home.png?raw=true">


### 인기 상품

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/loginhome.html)

- 메인화면의 상단 인기 판매 배너이다.
- url : /

#### 2. 컨트롤러 부분 (controller)
```java

@Slf4j
@Controller
@RequiredArgsConstructor
public class HomeController {
    private final ItemRepository itemRepository;

    @GetMapping("/")
    public String homeLogin(
            @Login Member loginMember, Model model
            ) {
        List<Item> items = itemRepository.findAll();
        List<Item> popularItems = itemRepository.findPopularItems();
        log.debug("items={}",items);
        model.addAttribute("popularItems",popularItems);
        model.addAttribute("items",items);
        log.debug("loginMember={}",loginMember);
        //로그인
        if (loginMember == null){
            return "home";
        }
        //세션이 유지되면 로그인 이동
        model.addAttribute("member", loginMember);
        return "loginHome";
    }

}
```

- GET :  /
  - 모든 아이템을 찾아 리스트로 받는다. itemRepository.finAll
  - 판매량 top 3개를 리스트로 받는다. itemRepository.findPopularItems()
  - model에 저장한다.
  - loginMember가 null이면 home.html을 리턴한다.
  - loginMember 객체가 있을시 model에 저장후 loginHome.html을 리턴한다.


#### 3. DBInterface(jdbc)
```java
    public List<Item> findAll() {
        String sql = "select * from item ORDER BY salesrate DESC";
        List<Item> itemList = new ArrayList<>();
        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            rs = pstmt.executeQuery();
            while (rs.next()) {
                Item item = new Item(
                        rs.getLong("seller_id"),
                        rs.getString("item_name"),
                        rs.getInt("item_price"),
                        rs.getInt("item_quantity"),
                        rs.getString("item_description"));
                item.setItemId(rs.getLong("item_id"));
                item.setSalesRate(rs.getInt("salesrate"));
                log.debug("itemRepo findAll item={}", item);
                itemList.add(item);
                if (rs.isLast()){
                    log.debug("itemRepo findAll itemList={}",itemList);
                    return itemList;
                }
            }
            throw new NoSuchFieldException();
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con, pstmt, rs);
        }
    }




    public List<Item> findPopularItems(){
        String sql = "SELECT * FROM (select * from item ORDER BY salesrate DESC) WHERE ROWNUM <=3 ;";
        List<Item> itemList = new ArrayList<>();

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            rs = pstmt.executeQuery();
            while (rs.next()){
                Item item = new Item(
                        rs.getLong("seller_id"),
                        rs.getString("item_name"),
                        rs.getInt("item_price"),
                        rs.getInt("item_quantity"),
                        rs.getString("item_description"));
                item.setItemId(rs.getLong("item_id"));
                item.setSalesRate(rs.getInt("salesrate"));
                log.debug("itemRepo findByMemberId item={}",item);
                itemList.add(item);
                if (rs.isLast()){
                    log.debug("itemRepo findByMemberId itemList={}",itemList);
                    return itemList;
                }
            }
            throw new NoSuchFieldException();
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }
    }
```
**itemRepository**
- findAll()
  - item 테이블에서 salesrate(판매량) 내림차순 정렬하여 모든 컬럼을 가져온다.
  - 이후 item객체로 바뀐뒤 List에 담아 리턴한다.
    ```sql
      select * from item ORDER BY salesrate DESC;
    ```
- findPopularItems()
  - item 테이블에서 salesrate(판매량) 내림차순 정렬 후 상위 3개만 가져온다.
  - 이후 컬럼 정보를 item 객체에 매핑 한뒤 list에 담아 리턴한다.
    ```sql
      SELECT * FROM (select * from item ORDER BY salesrate DESC) WHERE ROWNUM <=3 ;
    ```