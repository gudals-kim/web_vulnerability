package sec.web.domain.item;

import lombok.extern.slf4j.Slf4j;
import org.springframework.jdbc.datasource.DataSourceUtils;
import org.springframework.jdbc.support.JdbcUtils;
import org.springframework.stereotype.Repository;

import javax.sql.DataSource;
import java.sql.*;
import java.util.ArrayList;
import java.util.List;

import static sec.web.dbconnection.DBConnectionUtil.getConnection;

@Slf4j
@Repository
public class ItemRepository {
    private final DataSource dataSource;

    public ItemRepository(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    public void save(Item item){
        String sql = "insert into Item(member_id,item_name,item_price,item_quantity,item_description) values (?,?,?,?,?)";

        Connection con = null;
        PreparedStatement pstmt = null;
        try{
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,item.getSellerId());
            pstmt.setString(2,item.getName());
            pstmt.setInt(3,item.getPrice());
            pstmt.setInt(4,item.getQuantity());
            pstmt.setString(5,item.getDescription());
            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }

    public Item find(Long itemId){
        String sql = "select * from item where item_Id = ?";

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,itemId);
            rs = pstmt.executeQuery();
            if (rs.next()){
                Item item = new Item(
                        rs.getLong("member_id"),
                        rs.getString("item_name"),
                        rs.getInt("item_price"),
                        rs.getInt("item_quantity"),
                        rs.getString("item_description"));
                item.setItemId(itemId);
                return item;
            }else {
                throw new NoSuchFieldException("item table not found itemId = "+ itemId);
            }
        } catch (SQLException | NoSuchFieldException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }

    }
    public List<Item> findAll() {
        String sql = "select * from item";
        List<Item> itemList = new ArrayList<>();
        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            rs = pstmt.executeQuery();
            while (rs.next()) {
                Item item = new Item(
                        rs.getLong("member_id"),
                        rs.getString("item_name"),
                        rs.getInt("item_price"),
                        rs.getInt("item_quantity"),
                        rs.getString("item_description"));
                item.setItemId(rs.getLong("item_id"));
                log.debug("itemRepo findAll item={}", item);
                itemList.add(item);
                if (rs.isLast()){
                    log.debug("itemRepo findAll itemList={}",itemList);
                    return itemList;
                }
            }
            throw new NoSuchFieldException();
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con, pstmt, rs);
        }
    }

    public List<Item> findByMemberId(Long memberId){
        String sql = "select * from item where member_id = ?";
        List<Item> itemList = new ArrayList<>();

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,memberId);
            rs = pstmt.executeQuery();
            while (rs.next()){
                Item item = new Item(
                        rs.getLong("member_id"),
                        rs.getString("item_name"),
                        rs.getInt("item_price"),
                        rs.getInt("item_quantity"),
                        rs.getString("item_description"));
                item.setItemId(rs.getLong("item_id"));
                log.debug("itemRepo findByMemberId item={}",item);
                itemList.add(item);
                if (rs.isLast()){
                    log.debug("itemRepo findByMemberId itemList={}",itemList);
                    return itemList;
                }
            }
            throw new NoSuchFieldException();
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }
    }
    public void delete(Long itemId){
        String sql = "delete from item where item_id=?";
        Connection con = null;
        PreparedStatement pstmt = null;
        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,itemId);
            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con, pstmt, null);
        }
    }
    public void deleteByMemberId(Long memberId){
        String sql = "delete from item where member_id=?";
        Connection con = null;
        PreparedStatement pstmt = null;
        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,memberId);
            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con, pstmt, null);
        }
    }
    public void update(Item item){
        String sql = "update item set (item_name,item_price,item_quantity,item_description) = (?,?,?,?) where item_id=?";

        Connection con = null;
        PreparedStatement pstmt = null;
        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1,item.getName());
            pstmt.setInt(2,item.getPrice());
            pstmt.setInt(3,item.getQuantity());
            pstmt.setString(4,item.getDescription());
            pstmt.setLong(5,item.getItemId());

            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }
    private void createItem(){
        String sql = "  create table Item (\n" +
                "      item_id bigint not null AUTO_INCREMENT,\n" +
                "      member_id bigint,\n" +
                "      item_name varchar(45) not null,\n" +
                "      item_price integer not null,\n" +
                "      item_quantity integer not null,\n" +
                "      item_description varchar(255),\n" +
                "      primary key (item_id)\n" +
                "  );";
        Connection con = null;
        PreparedStatement pstmt = null;
        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }
    private void dropItem(){
        String sql = "drop table Item if exists cascade;";
        Connection con = null;
        PreparedStatement pstmt = null;
        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }
    private void alterItem(){
        String sql = "ALTER TABLE Item ADD FOREIGN KEY (member_id) REFERENCES member (member_id) ON UPDATE CASCADE;";
        Connection con = null;
        PreparedStatement pstmt = null;
        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }
    public void reset(){
        dropItem();
        createItem();
        alterItem();
    }
    private void close(Connection con, Statement stmt, ResultSet rs){
        JdbcUtils.closeResultSet(rs);
        JdbcUtils.closeStatement(stmt);

        DataSourceUtils.releaseConnection(con,dataSource);
    }

}
