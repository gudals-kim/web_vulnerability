# 👀 code review

## description
- 기능 단위로 기술합니다.
- 코드를 간단하게 설명합니다.
- html 및 thymeleaf 코드는 생략하고 해당 부분 git 링크를 남깁니다.


## summary
1. 회원 기능
   - 회원 가입
   - 회원 수정
   - 회원 조회
2. 로그인 기능
   - 세션/쿠키/인터셉터
   - 로그인
   - 로그아웃
3. 상품 기능
   - 상품 등록
   - 상품 수정
   - 상품 삭제
   - 상품 조회(단일)
   - 상품 조회(내가 등록한 상품)
   - 상품 조회(내가 구매한 상품)
4. 장바구니 기능
   - 장바구니 조회
   - 장바구니 삭제
5. 웹 머니
   - 상품 구매
   - 웹 머니 충전 

---

## 1. 회원 기능

### 회원 가입
#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/member/memberForm.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/img/memberAdd.png">

- 회원 가입 페이지 입니다.
- url : /members/add


#### 2. 컨트롤러 부분 (controller)
```java
@Controller
@RequiredArgsConstructor
@RequestMapping("/members")
public class AddMemberController {
    private final MemberRepository memberRepository;

    @GetMapping("/add")
    public String addForm(@ModelAttribute("addMember") AddMemberForm addMember){
        return "member/memberForm";
    }

    @PostMapping("/add")
    public String save(@Valid @ModelAttribute("addMember") AddMemberForm addMember, BindingResult bindingResult){
        Member findMember = memberRepository.find(addMember.getEmail());
        if (findMember != null){
            bindingResult.rejectValue("email","duplicateEmail","중복된 이메일 입니다.");
        }
        if (addMember.getConfirmPassword()!=addMember.getPassword()){
            bindingResult.rejectValue("confirmPassword","confirmPassword","비밀번호가 같지 않습니다.");
        }
        if (bindingResult.hasErrors()){
            return "member/memberForm";
        }
        Member member = new Member(addMember.getName(),addMember.getEmail(),addMember.getPassword());
        memberRepository.save(member);
        return "redirect:/login";
    }
}
```
- url : /members/add 를 처리합니다.
- **get 메서드로 들어오는 /add에선 addForm 메서드가 실행**되며, AddMemberForm에 정의된 데이터 형식을 사용하며 "member/memberForm.html"를 반환한다.
- **post 메서드로 들어오는 /add에선 save 메서드가 실행**되며, 
  - 사용자가 입력한 이메일을 검증하고 검증 실패시 bindingResult에 넣는다.
  - 사용자가 입력한 패스워드와 패스워드 확인의 데이터를 검증하고 검증 실패시 bindingResult에 넣는다.
  - bindingResult에 값이 있을시 다시 member/memberForm.html을 리턴한다.
  - 정상적으로 회원가입이 진행된 경우 /login url 를 리다이렉트 한다.

#### 3. DBInterface(jdbc)
```java
@Data
public class Member {
    private long id;
    @NotBlank
    private String name;
    @NotBlank
    @Pattern(regexp = "^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+.[A-Za-z]{2,6}$", message = "이메일 형식이 올바르지 않습니다.")
    private String email;
    @NotBlank
    @Pattern(regexp = "(?=.*[0-9])(?=.*[a-zA-Z])(?=.*\\W)(?=\\S+$).{8,16}")
    private String password;
    private int money;

    public Member() {
    }

    public Member(String name, String email, String password) {
        this.name = name;
        this.email = email;
        this.password = password;
    }
}
```

- member 객체
  - long id : db에서 자동으로 1씩 증가한다.
  - name : 공백을 허용하지 않는 Notblank 검증을 한다.
  - email : 공백을 허용하지 않고, 이메일 형식인지 검증을 한다.
  - password : 공백을 허용하지 않고, 특수문자,영문자,숫자의 혼합형태인지 검증을한다.
  - money : 회원가입할 시 기본 5000의 값이 들어간다.

```java
    public void save(Member member){
        String sql = "insert into member(member_name,member_email,member_password) values (?,?,?)";

        Connection con = null;
        PreparedStatement pstmt = null;
        try{
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1,member.getName());
            pstmt.setString(2,member.getEmail());
            pstmt.setString(3,member.getPassword());
            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }
```
- domain/member/memberRepository.java 의 save 메서드
  - member 객체를 받으면 멤버객체의 이름, 이메일, 패스워드를 insert쿼리로 날린다.


### 회원 수정

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/member/memberEdit.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/img/memberEdit.png">

- 회원 정보를 수정하는 화면이다.
- url : /member/{memberId}/edit

#### 2. 컨트롤러 부분 (controller)
```java
    @GetMapping("/{memberId}/edit")
    public String memberEdit(@PathVariable Long memberId,
                             Model model){
        Member member = memberRepository.find(memberId);
        AddMemberForm addMember = memberService.editMember(memberId, member);
        model.addAttribute("member",addMember);
        return "member/memberEdit";
    }



    @PostMapping("/{memberId}/edit")
    public String memberEdit(@PathVariable Long memberId,
            @Valid @ModelAttribute("member") AddMemberForm addMember, BindingResult bindingResult
    ){
        addMember.setId(memberId);
        if (bindingResult.hasErrors()){
            return "member/memberEdit";
        }
        if (memberService.isPasswordEqual(addMember)){
            memberService.changeMember(addMember, memberId);
            return "redirect:/member/{memberId}";
        }
        bindingResult.rejectValue("confirmPassword","confirmPassword","비밀번호가 같지 않습니다.");
        return "member/memberEdit";
    }
```

- GET : /member/{memberId}/edit
  - memberEdit 
    - @PathVariable 을 활용하여 url의 memberId를 받아서 현재 회원의 회원 정보를 db에서 찾아 member 객체로 반환받는다.
    - 찾은 member 객체를 AddMemberForm의 객체로 바꾸어 model에 저장한다.
    - member/memberEdit.html을 리턴한다.
- POST : /member/{memberId}/edit
  - memberEdit
    - 사용자가 폼에서 입력한 값을 addMemberForm의 객체로 받아왔다.
    - addMember에는 id가 없음으로 @PathVariable로 사용자의 id를 세팅해준다.
    - bindingresult에 오류가 있을시 memeber/memberEdit을 리턴한다.
    - 서비스 로직을 수행시 ture 일때, /member/{memberId}를 리다이렉트한다.


#### 3. 서비스 부분(service)
```java
    public boolean isPasswordEqual(AddMemberForm addMemberForm) {
        return addMemberForm.getPassword().equals(addMemberForm.getConfirmPassword());
    }
    public boolean isPasswordEqual(PasswordSetForm passwordSetForm) {
        return passwordSetForm.getPassword().equals(passwordSetForm.getConfirmPassword());
    }
```

- service/MemberService.java
  - 패스워드가 같은지 검증한다.

#### 4. DBInterface(jdbc)
```java
    public Member find(Long memberId){
        String sql = "select * from member where member_Id = ?";

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,memberId);
            rs = pstmt.executeQuery();
            if (rs.next()){
                Member member = new Member(
                        rs.getString("member_name"),
                        rs.getString("member_email"),
                        rs.getString("member_password"));
                member.setId(rs.getLong("member_id"));
                member.setMoney(rs.getInt("member_money"));
                return member;
            }else {
                throw new NoSuchFieldException("member not found memberId = "+ memberId);
            }
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }
    }
    
    public void update(Member member){
        String sql = "update member set (member_name, member_email, member_password) = (?,?,?) where member_id=?";

        Connection con = null;
        PreparedStatement pstmt = null;
        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1,member.getName());
            pstmt.setString(2,member.getEmail());
            pstmt.setString(3,member.getPassword());
            pstmt.setLong(4,member.getId());

            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }
```
- domain/member/memberRepository.java 의 find(Long **memberId**) 메서드
  - memberId를 받으면 "select * from member where member_Id = **memberId**" 쿼리를 날려서 멤버객체로 가져온다.
- domain/member/memberRepository.java 의 update(Member member) 메서드
  - member 객체를 받으면 멤버객체의 이름, 이메일, 패스워드를 update 쿼리로 날린다.


### 회원조회

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/member/member.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/img/member.png">

- 멤버 정보를 조회할때 보이는 페이지
- URL : /member/{memberId}

#### 2. 컨트롤러 부분 (controller)
```java
    @GetMapping("/{memberId}")
    public String member(@PathVariable Long memberId, Model model){
        Member findMember = memberRepository.find(memberId);
        model.addAttribute("member",findMember);
        return "member/member";
    }
```
- GET : /member/{memberId}
  - memberId 로 memberRepository에서 멤버를 찾아서 모델에 저장한다.
  - member/member.html을 리턴한다.

#### 3. DBInterface(jdbc)
```java
    public Member find(String memberEmail){
        String sql = "select * from member where member_email = ?";

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1,memberEmail);
            rs = pstmt.executeQuery();
            if (rs.next()){
                Member member = new Member(
                        rs.getString("member_name"),
                        rs.getString("member_email"),
                        rs.getString("member_password"));
                member.setId(rs.getLong("member_id"));
                member.setMoney(rs.getInt("member_money"));
                return member;
            }else {
                throw new NoSuchFieldException("member not found memberEmail = "+ memberEmail);
            }
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }

    }

    public Member find(Long memberId){
        String sql = "select * from member where member_Id = ?";

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,memberId);
            rs = pstmt.executeQuery();
            if (rs.next()){
                Member member = new Member(
                        rs.getString("member_name"),
                        rs.getString("member_email"),
                        rs.getString("member_password"));
                member.setId(rs.getLong("member_id"));
                member.setMoney(rs.getInt("member_money"));
                return member;
            }else {
                throw new NoSuchFieldException("member not found memberId = "+ memberId);
            }
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }
    }
```
- find(memberId) : memberId로 RDB에서 데이터를 가져와 Member 객체로 가져온다.
- find(memberEmail) : memberEmail이 중복가입이 안되기 때문에 Email이 key가 될 수 있다. 이후 코드는 상동



## 2. 로그인 기능

### 세션/쿠키, 스프링 인터셉터

#### 세션/쿠키
- 서블릿 request의 Session을 활용한다. 

#### 인터셉터 

```java
@Slf4j
public class LoginCheckInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {

        String requestURI = request.getRequestURI();
        log.info("인증 체크 인터셉터 실행 {}", requestURI);

        HttpSession session = request.getSession();
        if (session==null || session.getAttribute(LOGIN_MEMBER)==null){
            log.info("미인증 사용자 요청");
            response.sendRedirect("/login?redirectURL="+requestURI);
            return false;
        }
        return true;
    }
}
```
- 스프링의 인터셉터를 활용하여 로그인안되어 있을시(세션에 정보가 없을시) home으로 렌더하는 인터셉터를 구현했다.

#### webConfig : annotation Resolvers, addInterceptors를 만들어준다.
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addArgumentResolvers(List<HandlerMethodArgumentResolver> resolvers) {
        resolvers.add(new LoginMemberArgumentResolver());
    }

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new LogInterceptor())
                .order(1)
                .addPathPatterns("/**")
                .excludePathPatterns("/css/**","/*.ico","/error");
        registry.addInterceptor(new LoginCheckInterceptor())
                .order(2)
                .addPathPatterns("/**")
                .excludePathPatterns("/css/**","/*.ico","/members/add","/login","/logout","/error","/*","/member/find/**");
    }
}
```
- 내가 만든 어노테이션과 인터셉터를 스프링 컨텍스트에 설정해준다. 

#### @Login annotaion : 커스텀 로그인 annotaion

```java
@Target(ElementType.PARAMETER)
@Retention(RetentionPolicy.RUNTIME)
public @interface Login {}
```
type 설정 및 retention 설정을 해주었다.

```java
@Slf4j
public class LoginMemberArgumentResolver implements HandlerMethodArgumentResolver {
    @Override
    public boolean supportsParameter(MethodParameter parameter) {
        log.info("supportsParameter 실행");
        boolean hasLoginAnnotation = parameter.hasParameterAnnotation(Login.class);
        boolean hasMemberType = Member.class.isAssignableFrom(parameter.getParameterType());
        log.debug("hasLoginAnnotation={}",hasLoginAnnotation);
        log.debug("hasMemberType={}",hasMemberType);
        return hasMemberType && hasLoginAnnotation;
    }

    @Override
    public Object resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory) throws Exception {
        log.info("resolveArgument 실행");
        HttpServletRequest request = (HttpServletRequest) webRequest.getNativeRequest();
        log.debug("webRequest.getNativeRequest()={}",webRequest.getNativeRequest());
        HttpSession session = request.getSession(false);
        log.debug("session={}",session);
        if (session==null){
            return null;
        }
        log.debug("session.getAttribute(LOGIN_MEMBER)={}",session.getAttribute(LOGIN_MEMBER));
        return session.getAttribute(LOGIN_MEMBER);
    }
}
```
- 파라미터가 member 및 Login 어노테이션 클래스 일때 실행된다.
- request에서 세션정보를 가져왔을시 세션이 없다면 null을 리턴하고 있을시 세션정보를 리턴한다.

### 로그인/로그아웃


#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/member/memberForm.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/img/loginForm.png">


#### 2. 컨트롤러 부분 (controller)
```java
@Controller
@RequiredArgsConstructor
@Slf4j
public class LoginController {

    private final LoginService loginService;

    @GetMapping("/login")
    public String loginForm(@ModelAttribute("loginForm") LoginForm loginForm) {
        return "login/loginForm";
    }
    @PostMapping("/login")
    public String login(@Valid @ModelAttribute("loginForm") LoginForm loginForm,
                        BindingResult bindingResult,
                        @RequestParam(defaultValue = "/") String redirectURL,
                        HttpServletRequest request){
        if (bindingResult.hasErrors()){
            return "login/loginForm";
        }

        Member loginMember = loginService.login(loginForm.getEmail(), loginForm.getPassword());
        log.debug("loginMember={}",loginMember);
        if (loginMember == null){
            bindingResult.reject("loginFail","아이디 또는 비밀번호가 맞지 않습니다.");
            return "login/loginForm";
        }
        HttpSession session = request.getSession();
        session.setAttribute(LOGIN_MEMBER,loginMember);

        return "redirect:"+redirectURL;
    }
    
    @PostMapping("/logout")
    public String logout(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session!=null){
            session.invalidate();
        }
        return "redirect:/";
    }
}
```
- GET : /login
  - LoginForm을 modelAttribute로 담아서 login/loginForm.html을 리턴한다.
- POST : /login
  - bindingResult에 에러가 있으면 login/loginForm (<- 오류정보가 표시된다)을 바로 리턴한다.
  - loginService.login을 수행후 loginMember 가 null일시 bindingResult에 오류를 담고 login/loginForm을 리턴한다.
  - 로그인 서비스 성공시 세션에 담고 기존에 접근하려 했던 URL을 리다이렉트 해준다.
- POST : /logout
  - 현재 존재하는 세션을 찾아서 세션을 종료시킨다. 이후 홈화면으로 리다이렉트 한다.
  
#### 3. 서비스 부분(service)
```java
@Slf4j
@Service
public class LoginService {
    private final MemberRepository memberRepository;
    public LoginService(MemberRepository memberRepository){
        this.memberRepository = memberRepository;
    }
    public Member login(String loginEmail, String password){
        Member member = memberRepository.find(loginEmail);
        if (member!=null&&member.getPassword().equals(password)){
            log.debug("[member={}][input password={}]",member,password);
            return member;
        }
        return null;
    }
}
```
- login 메서드
  - email 과 패스워드를 입력 받는다.
  - email로 email에 해당하는 멤버의 정보를 가져온다.
  - 해당 멤버의 패스워드와 입력한 패스워드가 같을 시 찾은 멤버를 반환한다.
  - 같지 않을시 null을 리턴한다.











#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/member/memberForm.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/img/memberAdd.png">


#### 2. 컨트롤러 부분 (controller)
```java

```

#### 3. 서비스 부분(service)
```java

```

#### 4. DBInterface(jdbc)
```java


```