# ğŸ‘€ code review

## description
- ê¸°ëŠ¥ ë‹¨ìœ„ë¡œ ê¸°ìˆ í•©ë‹ˆë‹¤.
- ì½”ë“œë¥¼ ê°„ë‹¨í•˜ê²Œ ì„¤ëª…í•©ë‹ˆë‹¤.
- html ë° thymeleaf ì½”ë“œëŠ” ìƒëµí•˜ê³  í•´ë‹¹ ë¶€ë¶„ git ë§í¬ë¥¼ ë‚¨ê¹ë‹ˆë‹¤.


## summary
1. íšŒì› ê¸°ëŠ¥
   - íšŒì› ê°€ì…
   - íšŒì› ìˆ˜ì •
   - íšŒì› ì¡°íšŒ
2. ë¡œê·¸ì¸ ê¸°ëŠ¥
   - ì„¸ì…˜/ì¿ í‚¤/ì¸í„°ì…‰í„°
   - ë¡œê·¸ì¸
   - ë¡œê·¸ì•„ì›ƒ
3. ìƒí’ˆ ê¸°ëŠ¥
   - ìƒí’ˆ ë“±ë¡
   - ìƒí’ˆ ìˆ˜ì •
   - ìƒí’ˆ ì¡°íšŒ(ë‹¨ì¼)
   - ìƒí’ˆ ì¡°íšŒ(ë‚´ê°€ ë“±ë¡í•œ ìƒí’ˆ)
   - ìƒí’ˆ ì¡°íšŒ(ë‚´ê°€ êµ¬ë§¤í•œ ìƒí’ˆ)
4. ì¥ë°”êµ¬ë‹ˆ ê¸°ëŠ¥
   - ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒ
   - ì¥ë°”êµ¬ë‹ˆ ì‚­ì œ
5. ì›¹ ë¨¸ë‹ˆ
   - ìƒí’ˆ êµ¬ë§¤
   - ì›¹ ë¨¸ë‹ˆ ì¶©ì „ 
6. í™ˆ í™”ë©´
   - íŒë§¤ëŸ‰ top3 ìƒí’ˆ
   - ëª¨ë“  ìƒí’ˆ
   - ë†’ì€ í‰ì ì˜ ìƒí’ˆ
---

## 1. íšŒì› ê¸°ëŠ¥

### íšŒì› ê°€ì…
#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/member/memberForm.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/memberAdd.png?raw=true">

- íšŒì› ê°€ì… í˜ì´ì§€ ì…ë‹ˆë‹¤.
- url : /members/add


#### 2. ì»¨íŠ¸ë¡¤ëŸ¬ ë¶€ë¶„ (controller)
```java
@Controller
@RequiredArgsConstructor
@RequestMapping("/members")
public class AddMemberController {
    private final MemberRepository memberRepository;

    @GetMapping("/add")
    public String addForm(@ModelAttribute("addMember") AddMemberForm addMember){
        return "member/memberForm";
    }

    @PostMapping("/add")
    public String save(@Valid @ModelAttribute("addMember") AddMemberForm addMember, BindingResult bindingResult){
        Member findMember = memberRepository.find(addMember.getEmail());
        if (findMember != null){
            bindingResult.rejectValue("email","duplicateEmail","ì¤‘ë³µëœ ì´ë©”ì¼ ì…ë‹ˆë‹¤.");
        }
        if (addMember.getConfirmPassword()!=addMember.getPassword()){
            bindingResult.rejectValue("confirmPassword","confirmPassword","ë¹„ë°€ë²ˆí˜¸ê°€ ê°™ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
        if (bindingResult.hasErrors()){
            return "member/memberForm";
        }
        Member member = new Member(addMember.getName(),addMember.getEmail(),addMember.getPassword());
        memberRepository.save(member);
        return "redirect:/login";
    }
}
```
- url : /members/add ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
- **get ë©”ì„œë“œë¡œ ë“¤ì–´ì˜¤ëŠ” /addì—ì„  addForm ë©”ì„œë“œê°€ ì‹¤í–‰**ë˜ë©°, AddMemberFormì— ì •ì˜ëœ ë°ì´í„° í˜•ì‹ì„ ì‚¬ìš©í•˜ë©° "member/memberForm.html"ë¥¼ ë°˜í™˜í•œë‹¤.
- **post ë©”ì„œë“œë¡œ ë“¤ì–´ì˜¤ëŠ” /addì—ì„  save ë©”ì„œë“œê°€ ì‹¤í–‰**ë˜ë©°, 
  - ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì´ë©”ì¼ì„ ê²€ì¦í•˜ê³  ê²€ì¦ ì‹¤íŒ¨ì‹œ bindingResultì— ë„£ëŠ”ë‹¤.
  - ì‚¬ìš©ìê°€ ì…ë ¥í•œ íŒ¨ìŠ¤ì›Œë“œì™€ íŒ¨ìŠ¤ì›Œë“œ í™•ì¸ì˜ ë°ì´í„°ë¥¼ ê²€ì¦í•˜ê³  ê²€ì¦ ì‹¤íŒ¨ì‹œ bindingResultì— ë„£ëŠ”ë‹¤.
  - bindingResultì— ê°’ì´ ìˆì„ì‹œ ë‹¤ì‹œ member/memberForm.htmlì„ ë¦¬í„´í•œë‹¤.
  - ì •ìƒì ìœ¼ë¡œ íšŒì›ê°€ì…ì´ ì§„í–‰ëœ ê²½ìš° /login url ë¥¼ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•œë‹¤.

#### 3. DBInterface(jdbc)
```java
@Data
public class Member {
    private long id;
    @NotBlank
    private String name;
    @NotBlank
    @Pattern(regexp = "^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+.[A-Za-z]{2,6}$", message = "ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
    private String email;
    @NotBlank
    @Pattern(regexp = "(?=.*[0-9])(?=.*[a-zA-Z])(?=.*\\W)(?=\\S+$).{8,16}")
    private String password;
    private int money;

    public Member() {
    }

    public Member(String name, String email, String password) {
        this.name = name;
        this.email = email;
        this.password = password;
    }
}
```

- member ê°ì²´
  - long id : dbì—ì„œ ìë™ìœ¼ë¡œ 1ì”© ì¦ê°€í•œë‹¤.
  - name : ê³µë°±ì„ í—ˆìš©í•˜ì§€ ì•ŠëŠ” Notblank ê²€ì¦ì„ í•œë‹¤.
  - email : ê³µë°±ì„ í—ˆìš©í•˜ì§€ ì•Šê³ , ì´ë©”ì¼ í˜•ì‹ì¸ì§€ ê²€ì¦ì„ í•œë‹¤.
  - password : ê³µë°±ì„ í—ˆìš©í•˜ì§€ ì•Šê³ , íŠ¹ìˆ˜ë¬¸ì,ì˜ë¬¸ì,ìˆ«ìì˜ í˜¼í•©í˜•íƒœì¸ì§€ ê²€ì¦ì„í•œë‹¤.
  - money : íšŒì›ê°€ì…í•  ì‹œ ê¸°ë³¸ 5000ì˜ ê°’ì´ ë“¤ì–´ê°„ë‹¤.

```java
    public void save(Member member){
        String sql = "insert into member(member_name,member_email,member_password) values (?,?,?)";

        Connection con = null;
        PreparedStatement pstmt = null;
        try{
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1,member.getName());
            pstmt.setString(2,member.getEmail());
            pstmt.setString(3,member.getPassword());
            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }
```
- domain/member/memberRepository.java ì˜ save ë©”ì„œë“œ
  - member ê°ì²´ë¥¼ ë°›ìœ¼ë©´ ë©¤ë²„ê°ì²´ì˜ ì´ë¦„, ì´ë©”ì¼, íŒ¨ìŠ¤ì›Œë“œë¥¼ insertì¿¼ë¦¬ë¡œ ë‚ ë¦°ë‹¤.


### íšŒì› ìˆ˜ì •

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/member/memberEdit.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/memberEdit.png?raw=true">

- íšŒì› ì •ë³´ë¥¼ ìˆ˜ì •í•˜ëŠ” í™”ë©´ì´ë‹¤.
- url : /member/{memberId}/edit

#### 2. ì»¨íŠ¸ë¡¤ëŸ¬ ë¶€ë¶„ (controller)
```java
    @GetMapping("/{memberId}/edit")
    public String memberEdit(@PathVariable Long memberId,
                             Model model){
        Member member = memberRepository.find(memberId);
        AddMemberForm addMember = memberService.editMember(memberId, member);
        model.addAttribute("member",addMember);
        return "member/memberEdit";
    }



    @PostMapping("/{memberId}/edit")
    public String memberEdit(@PathVariable Long memberId,
            @Valid @ModelAttribute("member") AddMemberForm addMember, BindingResult bindingResult
    ){
        addMember.setId(memberId);
        if (bindingResult.hasErrors()){
            return "member/memberEdit";
        }
        if (memberService.isPasswordEqual(addMember)){
            memberService.changeMember(addMember, memberId);
            return "redirect:/member/{memberId}";
        }
        bindingResult.rejectValue("confirmPassword","confirmPassword","ë¹„ë°€ë²ˆí˜¸ê°€ ê°™ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return "member/memberEdit";
    }
```

- GET : /member/{memberId}/edit
  - memberEdit 
    - @PathVariable ì„ í™œìš©í•˜ì—¬ urlì˜ memberIdë¥¼ ë°›ì•„ì„œ í˜„ì¬ íšŒì›ì˜ íšŒì› ì •ë³´ë¥¼ dbì—ì„œ ì°¾ì•„ member ê°ì²´ë¡œ ë°˜í™˜ë°›ëŠ”ë‹¤.
    - ì°¾ì€ member ê°ì²´ë¥¼ AddMemberFormì˜ ê°ì²´ë¡œ ë°”ê¾¸ì–´ modelì— ì €ì¥í•œë‹¤.
    - member/memberEdit.htmlì„ ë¦¬í„´í•œë‹¤.
- POST : /member/{memberId}/edit
  - memberEdit
    - ì‚¬ìš©ìê°€ í¼ì—ì„œ ì…ë ¥í•œ ê°’ì„ addMemberFormì˜ ê°ì²´ë¡œ ë°›ì•„ì™”ë‹¤.
    - addMemberì—ëŠ” idê°€ ì—†ìŒìœ¼ë¡œ @PathVariableë¡œ ì‚¬ìš©ìì˜ idë¥¼ ì„¸íŒ…í•´ì¤€ë‹¤.
    - bindingresultì— ì˜¤ë¥˜ê°€ ìˆì„ì‹œ memeber/memberEditì„ ë¦¬í„´í•œë‹¤.
    - ì„œë¹„ìŠ¤ ë¡œì§ì„ ìˆ˜í–‰ì‹œ ture ì¼ë•Œ, /member/{memberId}ë¥¼ ë¦¬ë‹¤ì´ë ‰íŠ¸í•œë‹¤.


#### 3. ì„œë¹„ìŠ¤ ë¶€ë¶„(service)
```java
    public boolean isPasswordEqual(AddMemberForm addMemberForm) {
        return addMemberForm.getPassword().equals(addMemberForm.getConfirmPassword());
    }
    public boolean isPasswordEqual(PasswordSetForm passwordSetForm) {
        return passwordSetForm.getPassword().equals(passwordSetForm.getConfirmPassword());
    }
```

- service/MemberService.java
  - íŒ¨ìŠ¤ì›Œë“œê°€ ê°™ì€ì§€ ê²€ì¦í•œë‹¤.

#### 4. DBInterface(jdbc)
```java
    public Member find(Long memberId){
        String sql = "select * from member where member_Id = ?";

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,memberId);
            rs = pstmt.executeQuery();
            if (rs.next()){
                Member member = new Member(
                        rs.getString("member_name"),
                        rs.getString("member_email"),
                        rs.getString("member_password"));
                member.setId(rs.getLong("member_id"));
                member.setMoney(rs.getInt("member_money"));
                return member;
            }else {
                throw new NoSuchFieldException("member not found memberId = "+ memberId);
            }
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }
    }
    
    public void update(Member member){
        String sql = "update member set (member_name, member_email, member_password) = (?,?,?) where member_id=?";

        Connection con = null;
        PreparedStatement pstmt = null;
        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1,member.getName());
            pstmt.setString(2,member.getEmail());
            pstmt.setString(3,member.getPassword());
            pstmt.setLong(4,member.getId());

            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }
```
- domain/member/memberRepository.java ì˜ find(Long **memberId**) ë©”ì„œë“œ
  - memberIdë¥¼ ë°›ìœ¼ë©´ "select * from member where member_Id = **memberId**" ì¿¼ë¦¬ë¥¼ ë‚ ë ¤ì„œ ë©¤ë²„ê°ì²´ë¡œ ê°€ì ¸ì˜¨ë‹¤.
- domain/member/memberRepository.java ì˜ update(Member member) ë©”ì„œë“œ
  - member ê°ì²´ë¥¼ ë°›ìœ¼ë©´ ë©¤ë²„ê°ì²´ì˜ ì´ë¦„, ì´ë©”ì¼, íŒ¨ìŠ¤ì›Œë“œë¥¼ update ì¿¼ë¦¬ë¡œ ë‚ ë¦°ë‹¤.


### íšŒì›ì¡°íšŒ

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/member/member.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/member.png?raw=true">

- ë©¤ë²„ ì •ë³´ë¥¼ ì¡°íšŒí• ë•Œ ë³´ì´ëŠ” í˜ì´ì§€
- URL : /member/{memberId}

#### 2. ì»¨íŠ¸ë¡¤ëŸ¬ ë¶€ë¶„ (controller)
```java
    @GetMapping("/{memberId}")
    public String member(@PathVariable Long memberId, Model model){
        Member findMember = memberRepository.find(memberId);
        model.addAttribute("member",findMember);
        return "member/member";
    }
```
- GET : /member/{memberId}
  - memberId ë¡œ memberRepositoryì—ì„œ ë©¤ë²„ë¥¼ ì°¾ì•„ì„œ ëª¨ë¸ì— ì €ì¥í•œë‹¤.
  - member/member.htmlì„ ë¦¬í„´í•œë‹¤.

#### 3. DBInterface(jdbc)
```java
    public Member find(String memberEmail){
        String sql = "select * from member where member_email = ?";

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1,memberEmail);
            rs = pstmt.executeQuery();
            if (rs.next()){
                Member member = new Member(
                        rs.getString("member_name"),
                        rs.getString("member_email"),
                        rs.getString("member_password"));
                member.setId(rs.getLong("member_id"));
                member.setMoney(rs.getInt("member_money"));
                return member;
            }else {
                throw new NoSuchFieldException("member not found memberEmail = "+ memberEmail);
            }
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }

    }

    public Member find(Long memberId){
        String sql = "select * from member where member_Id = ?";

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,memberId);
            rs = pstmt.executeQuery();
            if (rs.next()){
                Member member = new Member(
                        rs.getString("member_name"),
                        rs.getString("member_email"),
                        rs.getString("member_password"));
                member.setId(rs.getLong("member_id"));
                member.setMoney(rs.getInt("member_money"));
                return member;
            }else {
                throw new NoSuchFieldException("member not found memberId = "+ memberId);
            }
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }
    }
```
- find(memberId) : memberIdë¡œ RDBì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ Member ê°ì²´ë¡œ ê°€ì ¸ì˜¨ë‹¤.
- find(memberEmail) : memberEmailì´ ì¤‘ë³µê°€ì…ì´ ì•ˆë˜ê¸° ë•Œë¬¸ì— Emailì´ keyê°€ ë  ìˆ˜ ìˆë‹¤. ì´í›„ ì½”ë“œëŠ” ìƒë™

---

## 2. ë¡œê·¸ì¸ ê¸°ëŠ¥

### ì„¸ì…˜/ì¿ í‚¤, ìŠ¤í”„ë§ ì¸í„°ì…‰í„°

#### ì„¸ì…˜/ì¿ í‚¤
- ì„œë¸”ë¦¿ requestì˜ Sessionì„ í™œìš©í•œë‹¤. 

#### ì¸í„°ì…‰í„° 

```java
@Slf4j
public class LoginCheckInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {

        String requestURI = request.getRequestURI();
        log.info("ì¸ì¦ ì²´í¬ ì¸í„°ì…‰í„° ì‹¤í–‰ {}", requestURI);

        HttpSession session = request.getSession();
        if (session==null || session.getAttribute(LOGIN_MEMBER)==null){
            log.info("ë¯¸ì¸ì¦ ì‚¬ìš©ì ìš”ì²­");
            response.sendRedirect("/login?redirectURL="+requestURI);
            return false;
        }
        return true;
    }
}
```
- ìŠ¤í”„ë§ì˜ ì¸í„°ì…‰í„°ë¥¼ í™œìš©í•˜ì—¬ ë¡œê·¸ì¸ì•ˆë˜ì–´ ìˆì„ì‹œ(ì„¸ì…˜ì— ì •ë³´ê°€ ì—†ì„ì‹œ) homeìœ¼ë¡œ ë Œë”í•˜ëŠ” ì¸í„°ì…‰í„°ë¥¼ êµ¬í˜„í–ˆë‹¤.

#### webConfig : annotation Resolvers, addInterceptorsë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addArgumentResolvers(List<HandlerMethodArgumentResolver> resolvers) {
        resolvers.add(new LoginMemberArgumentResolver());
    }

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new LogInterceptor())
                .order(1)
                .addPathPatterns("/**")
                .excludePathPatterns("/css/**","/*.ico","/error");
        registry.addInterceptor(new LoginCheckInterceptor())
                .order(2)
                .addPathPatterns("/**")
                .excludePathPatterns("/css/**","/*.ico","/members/add","/login","/logout","/error","/*","/member/find/**");
    }
}
```
- ë‚´ê°€ ë§Œë“  ì–´ë…¸í…Œì´ì…˜ê³¼ ì¸í„°ì…‰í„°ë¥¼ ìŠ¤í”„ë§ ì»¨í…ìŠ¤íŠ¸ì— ì„¤ì •í•´ì¤€ë‹¤. 

#### @Login annotaion : ì»¤ìŠ¤í…€ ë¡œê·¸ì¸ annotaion

```java
@Target(ElementType.PARAMETER)
@Retention(RetentionPolicy.RUNTIME)
public @interface Login {}
```
type ì„¤ì • ë° retention ì„¤ì •ì„ í•´ì£¼ì—ˆë‹¤.

```java
@Slf4j
public class LoginMemberArgumentResolver implements HandlerMethodArgumentResolver {
    @Override
    public boolean supportsParameter(MethodParameter parameter) {
        log.info("supportsParameter ì‹¤í–‰");
        boolean hasLoginAnnotation = parameter.hasParameterAnnotation(Login.class);
        boolean hasMemberType = Member.class.isAssignableFrom(parameter.getParameterType());
        log.debug("hasLoginAnnotation={}",hasLoginAnnotation);
        log.debug("hasMemberType={}",hasMemberType);
        return hasMemberType && hasLoginAnnotation;
    }

    @Override
    public Object resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory) throws Exception {
        log.info("resolveArgument ì‹¤í–‰");
        HttpServletRequest request = (HttpServletRequest) webRequest.getNativeRequest();
        log.debug("webRequest.getNativeRequest()={}",webRequest.getNativeRequest());
        HttpSession session = request.getSession(false);
        log.debug("session={}",session);
        if (session==null){
            return null;
        }
        log.debug("session.getAttribute(LOGIN_MEMBER)={}",session.getAttribute(LOGIN_MEMBER));
        return session.getAttribute(LOGIN_MEMBER);
    }
}
```
- íŒŒë¼ë¯¸í„°ê°€ member ë° Login ì–´ë…¸í…Œì´ì…˜ í´ë˜ìŠ¤ ì¼ë•Œ ì‹¤í–‰ëœë‹¤.
- requestì—ì„œ ì„¸ì…˜ì •ë³´ë¥¼ ê°€ì ¸ì™”ì„ì‹œ ì„¸ì…˜ì´ ì—†ë‹¤ë©´ nullì„ ë¦¬í„´í•˜ê³  ìˆì„ì‹œ ì„¸ì…˜ì •ë³´ë¥¼ ë¦¬í„´í•œë‹¤.

### ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ


#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/member/memberForm.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/loginForm.png?raw=true">


#### 2. ì»¨íŠ¸ë¡¤ëŸ¬ ë¶€ë¶„ (controller)
```java
@Controller
@RequiredArgsConstructor
@Slf4j
public class LoginController {

    private final LoginService loginService;

    @GetMapping("/login")
    public String loginForm(@ModelAttribute("loginForm") LoginForm loginForm) {
        return "login/loginForm";
    }
    @PostMapping("/login")
    public String login(@Valid @ModelAttribute("loginForm") LoginForm loginForm,
                        BindingResult bindingResult,
                        @RequestParam(defaultValue = "/") String redirectURL,
                        HttpServletRequest request){
        if (bindingResult.hasErrors()){
            return "login/loginForm";
        }

        Member loginMember = loginService.login(loginForm.getEmail(), loginForm.getPassword());
        log.debug("loginMember={}",loginMember);
        if (loginMember == null){
            bindingResult.reject("loginFail","ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return "login/loginForm";
        }
        HttpSession session = request.getSession();
        session.setAttribute(LOGIN_MEMBER,loginMember);

        return "redirect:"+redirectURL;
    }
    
    @PostMapping("/logout")
    public String logout(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session!=null){
            session.invalidate();
        }
        return "redirect:/";
    }
}
```
- GET : /login
  - LoginFormì„ modelAttributeë¡œ ë‹´ì•„ì„œ login/loginForm.htmlì„ ë¦¬í„´í•œë‹¤.
- POST : /login
  - bindingResultì— ì—ëŸ¬ê°€ ìˆìœ¼ë©´ login/loginForm (<- ì˜¤ë¥˜ì •ë³´ê°€ í‘œì‹œëœë‹¤)ì„ ë°”ë¡œ ë¦¬í„´í•œë‹¤.
  - loginService.loginì„ ìˆ˜í–‰í›„ loginMember ê°€ nullì¼ì‹œ bindingResultì— ì˜¤ë¥˜ë¥¼ ë‹´ê³  login/loginFormì„ ë¦¬í„´í•œë‹¤.
  - ë¡œê·¸ì¸ ì„œë¹„ìŠ¤ ì„±ê³µì‹œ ì„¸ì…˜ì— ë‹´ê³  ê¸°ì¡´ì— ì ‘ê·¼í•˜ë ¤ í–ˆë˜ URLì„ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•´ì¤€ë‹¤.
- POST : /logout
  - í˜„ì¬ ì¡´ì¬í•˜ëŠ” ì„¸ì…˜ì„ ì°¾ì•„ì„œ ì„¸ì…˜ì„ ì¢…ë£Œì‹œí‚¨ë‹¤. ì´í›„ í™ˆí™”ë©´ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•œë‹¤.
  
#### 3. ì„œë¹„ìŠ¤ ë¶€ë¶„(service)
```java
@Slf4j
@Service
public class LoginService {
    private final MemberRepository memberRepository;
    public LoginService(MemberRepository memberRepository){
        this.memberRepository = memberRepository;
    }
    public Member login(String loginEmail, String password){
        Member member = memberRepository.find(loginEmail);
        if (member!=null&&member.getPassword().equals(password)){
            log.debug("[member={}][input password={}]",member,password);
            return member;
        }
        return null;
    }
}
```
- login ë©”ì„œë“œ
  - email ê³¼ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥ ë°›ëŠ”ë‹¤.
  - emailë¡œ emailì— í•´ë‹¹í•˜ëŠ” ë©¤ë²„ì˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
  - í•´ë‹¹ ë©¤ë²„ì˜ íŒ¨ìŠ¤ì›Œë“œì™€ ì…ë ¥í•œ íŒ¨ìŠ¤ì›Œë“œê°€ ê°™ì„ ì‹œ ì°¾ì€ ë©¤ë²„ë¥¼ ë°˜í™˜í•œë‹¤.
  - ê°™ì§€ ì•Šì„ì‹œ nullì„ ë¦¬í„´í•œë‹¤.

---

## 3. ìƒí’ˆ ê¸°ëŠ¥

### ìƒí’ˆ ë“±ë¡

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/item/itemAdd.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/itemAdd.png?raw=true">

- ìƒí’ˆì„ ë“±ë¡í•˜ëŠ” í™”ë©´ì´ë‹¤.
- url : /item/items/{memberId}/add

#### 2. ì»¨íŠ¸ë¡¤ëŸ¬ ë¶€ë¶„ (controller)
```java
    @GetMapping("/items/{memberId}/add")
    public String addItem(@ModelAttribute("addItemForm") AddItemForm addItemForm,
                          @PathVariable Long memberId){
        return "item/itemAdd";
    }
    @PostMapping("/items/{memberId}/add")
    public String addItem(@ModelAttribute("addItemForm") AddItemForm addItemForm,
                          BindingResult bindingResult,
                          @PathVariable Long memberId){
        if (bindingResult.hasErrors()){
            return "item/itemAdd";
        }
        if (itemRepository.findByItemName(addItemForm.getItemName())!=null){
            bindingResult.rejectValue("itemName","itemName","ì¤‘ë³µëœ ìƒí’ˆëª…ì´ ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ìƒí’ˆëª…ì„ ë“±ë¡í•˜ì‹­ì‹œì˜¤");
            return "item/itemAdd";
        }
        Item addItem = new Item(memberId,
                addItemForm.getItemName(),
                addItemForm.getPrice(),
                addItemForm.getQuantity(),
                addItemForm.getDescription());
        itemRepository.save(addItem);
        return "redirect:/item/items/{memberId}";
    }
```
- GET : /item/items/{memberId}/add
  - addItemFormê³¼ memberIdë¥¼ itemAdd.htmlì— ë„˜ê¸´ë’¤ item/itemAdd.htmlì„ ë¦¬í„´í•œë‹¤.
- POST : /item/items/{memberId}/add
  - addItemFormì— ë“¤ì–´ì˜¨ ë°ì´í„°ë¥¼ í™•ì¸í•œë‹¤.
  - ê²€ì¦ ë’¤ ì´ìƒì´ ì—†ìœ¼ë©´ Item ê°ì²´ë¡œ ë³€í™˜í›„ itemRepository.save ë©”ì„œë“œë¡œ rdbì— ì €ì¥í•œë‹¤.
  - ì´í›„ item/items/{memberId}ë¥¼ ë¦¬í„´í•œë‹¤.

#### 3. DTO ë¶€ë¶„ (DTO)
```java
@Data
public class AddItemForm {
    @NotNull
    String itemName;
    @NotNull
    @Range(min = 1000, max = 1000000)
    private Integer price;
    @NotNull
    @Range(min = 1, max = 10000)
    private Integer quantity;
    private String description;

    public AddItemForm(String itemName, Integer price, Integer quantity, String description) {
        this.itemName = itemName;
        this.price = price;
        this.quantity = quantity;
        this.description = description;
    }
}
```
- itemName : ê³µë°±ì„ í—ˆìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
- price : ê³µë°±ì„ í—ˆìš©í•˜ì§€ ì•Šê³  1000~1000000 ì‚¬ì´ì˜ ê°’ë§Œ ë°›ëŠ”ë‹¤.
- quantity : ê³µë°±ì„ í—ˆìš©í•˜ì§€ ì•Šê³  1 ~ 10000 ì‚¬ì´ì˜ ê°’ë§Œ ë°›ëŠ”ë‹¤.
- description : ê²€ì¦ x

#### 4. DBInterface(jdbc)
```java
@Data
public class Item {
    private Long itemId;
    private Long sellerId;
    private String name;
    private Integer price;
    private Integer quantity;
    private String description;
    private Integer salesRate;

    public Item() {
    }

    public Item(Long sellerId, String name, Integer price, Integer quantity, String description) {
        this.sellerId = sellerId;
        this.name = name;
        this.price = price;
        this.quantity = quantity;
        this.description = description;
    }
}
```
- item ê°ì²´
  - itemId = ì•„ì´í…œ ì•„ì´ë”” (dbì— ì €ì¥ì‹œ ìë™ ì¦ê°€)
  - sellerId = íŒë§¤ì íšŒì› ì•„ì´ë”” 
  - name = ìƒí’ˆ ì´ë¦„
  - price = ìƒí’ˆ ê°€ê²©
  - quantity = ìƒí’ˆ ìˆ˜ëŸ‰
  - description = ìƒí’ˆ ì„¤ëª…
  - salesRate = ìƒí’ˆ íŒë§¤ëŸ‰

```java
public void save(Item item){
        String sql = "insert into Item(seller_id,item_name,item_price,item_quantity,item_description) values (?,?,?,?,?)";

        Connection con = null;
        PreparedStatement pstmt = null;
        try{
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,item.getSellerId());
            pstmt.setString(2,item.getName());
            pstmt.setInt(3,item.getPrice());
            pstmt.setInt(4,item.getQuantity());
            pstmt.setString(5,item.getDescription());
            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }
```

- domain/item/itemRepository 
  - save ë§¤ì„œë“œ 
    - item ê°ì²´ë¥¼ ë°›ì•„ì„œ insert ì¿¼ë¦¬ë¥¼ ë‚ ë ¤ì„œ RDBì— ì €ì¥í•œë‹¤. 
    - insert into Item(seller_id,item_name,item_price,item_quantity,item_description) values (?,?,?,?,?)

### ìƒí’ˆ ìˆ˜ì •

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/itemEdit/itemEdit.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/itemEdit.png?raw=true">

- ìƒí’ˆ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ëŠ” í™”ë©´ì´ë‹¤.
- url : /item/{memeberId}/{itemId}/edit

#### 2. ì»¨íŠ¸ë¡¤ëŸ¬ ë¶€ë¶„ (controller)
```java
    @GetMapping("/{memberId}/{itemId}/edit")
    public String editItem(@ModelAttribute("addItemForm") AddItemForm addItemForm,
                           @PathVariable Long memberId,
                           @PathVariable Long itemId,
                           Model model){
        Item item = itemRepository.find(itemId);
        addItemForm.setItemName(item.getName());
        addItemForm.setPrice(item.getPrice());
        addItemForm.setQuantity(item.getQuantity());
        addItemForm.setDescription(item.getDescription());
        model.addAttribute("addItemForm",addItemForm);
        return "item/itemEdit";
    }
    @PostMapping("/{memberId}/{itemId}/edit")
    public String editItem(@ModelAttribute("addItemForm") AddItemForm addItemForm,
                           BindingResult bindingResult,
                           @PathVariable Long itemId,
                           @PathVariable Long memberId){
        if (bindingResult.hasErrors()){
            return "item/itemEdit";
        }

        Item updateItem = itemRepository.find(itemId);
        updateItem.setName(addItemForm.getItemName());
        updateItem.setPrice(addItemForm.getPrice());
        updateItem.setQuantity(addItemForm.getQuantity());
        updateItem.setDescription(addItemForm.getDescription());
        itemRepository.update(updateItem);
        return "redirect:/item/items/{memberId}";
    }
```
- GET : /item/{memberId}/{itemId}/edit
  - itemIdìœ¼ë¡œ item ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ ë’¤ addItemFormì— ì •ë³´ë¥¼ htmlì— ë„˜ê²¨ì¤€ë’¤ item/itemEdit.htmlì„ ë¦¬í„´í•œë‹¤.
  - ìˆ˜ì •ì‹œ ê¸°ì¡´ ë°ì´í„°ë¥¼ ë³´ì—¬ì£¼ê³  ì‹¶ê¸° ë•Œë¬¸ì— ì°¾ì•„ì„œ ë°ì´í„°ë¥¼ ë„˜ê²¨ì£¼ì—ˆë‹¤.
- POST : /item/{memberId}/{itemId}/edit
  - bindingResultì— ì—ëŸ¬ê°€ ìˆìœ¼ë©´ item/itemEdit.htmlì„ ë¦¬í„´í•œë‹¤.
  - ìˆ˜ì • í•  itemì„ itemRepositoryì—ì„œ ì°¾ì€ë’¤ addItemFormì— ë“¤ì–´ì˜¨ ë°ì´í„°ë¡œ ë°”ê¾¸ì–´ì¤€ë‹¤.
  - ì´í›„ update í•œë’¤ /item/items/{memberId}ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•œë‹¤.



#### 3. DBInterface(jdbc)
```java

    public void update(Item item){
        String sql = "update item set (item_name,item_price,item_quantity,item_description,salesrate) = (?,?,?,?,?) where item_id=?";

        Connection con = null;
        PreparedStatement pstmt = null;
        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1,item.getName());
            pstmt.setInt(2,item.getPrice());
            pstmt.setInt(3,item.getQuantity());
            pstmt.setString(4,item.getDescription());
            pstmt.setInt(5,item.getSalesRate());
            pstmt.setLong(6,item.getItemId());

            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }

```

- update(Item item)
  - item ê°ì²´(ìˆ˜ì •ëœ ê°ì²´)ë¥¼ ë°›ì•„ì„œ í•´ë‹¹ itemIdì— updateì¿¼ë¦¬ë¥¼ ë‚ ë ¤ì¤€ë‹¤.
    ```sql
    update item 
            set (item_name,item_price,item_quantity,item_description,salesrate) = (?,?,?,?,?)
                where item_id=?(item.getItemId())
    ```

### ìƒí’ˆ ì¡°íšŒ(ë‹¨ì¼)

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/item/item.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/item.png?raw=true">

- ìƒí’ˆ ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” í™”ë©´ì´ë‹¤.
- url : /item/{itemId}

#### 2. ì»¨íŠ¸ë¡¤ëŸ¬ ë¶€ë¶„ (controller)
```java
    @GetMapping("/{itemId}")
    public String item(@PathVariable Long itemId, Model model, HttpServletRequest request){
        Item item = itemRepository.find(itemId);
        HttpSession session = request.getSession();
        Member member = (Member)session.getAttribute(SessionConst.LOGIN_MEMBER);
        model.addAttribute("member",member);
        model.addAttribute("item",item);
        return "item/item";
    }
```
- GET : /item/{itemId}
  - itemIdë¥¼ í†µí•´ item ê°ì²´ë¥¼ itemRepositoryì—ì„œ ê°€ì ¸ì˜¨ë‹¤.
  - ì„¸ì…˜ì—ì„œ í˜„ì¬ ë¡œê·¸ì¸ëœ ë©¤ë²„ê°ì²´ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
  - ëª¨ë¸ì— ë©¤ë²„ì™€ ì•„ì´í…œì„ ë‹´ê³  item/item.htmlì„ ë¦¬í„´í•œë‹¤.


#### 3. DBInterface(jdbc)
```java
    public Item find(Long itemId){
        String sql = "select * from item where item_Id = ?";

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,itemId);
            rs = pstmt.executeQuery();
            if (rs.next()){
                Item item = new Item(
                        rs.getLong("seller_id"),
                        rs.getString("item_name"),
                        rs.getInt("item_price"),
                        rs.getInt("item_quantity"),
                        rs.getString("item_description"));
                item.setItemId(itemId);
                item.setSalesRate(rs.getInt("salesrate"));
                return item;
            }else {
                throw new NoSuchFieldException("item table not found itemId = "+ itemId);
            }
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }
    }
```
- find(Long itemId)
  - itemIdì— í•´ë‹¹í•˜ëŠ” item tableì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ITEM ê°ì²´ë¡œ ë°”ê¾¸ì–´ ë¦¬í„´í•œë‹¤.
    ```sql
      select * from item where item_Id = ? (itemID)
    ```

  

### ìƒí’ˆ ì¡°íšŒ(ë‚´ê°€ ë“±ë¡í•œ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸)

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/item/registerItems.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/registerItems.png?raw=true">

- ë‚´ê°€ ë“±ë¡í•œ ìƒí’ˆ ëª©ë¡ì„ ë³´ì—¬ì£¼ëŠ” í™”ë©´ì´ë‹¤. (ìƒí’ˆ ë“±ë¡, ìˆ˜ì •ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŒ)
- url : /item/items/{memberId}

#### 2. ì»¨íŠ¸ë¡¤ëŸ¬ ë¶€ë¶„ (controller)
```java
    @GetMapping("/items/{memberId}")
    public String registeredItems(@PathVariable Long memberId, Model model){
        List<Item> registerItems = itemRepository.findBySellerId(memberId);
        if (registerItems==null){
            //ë“±ë¡ ìƒí’ˆì´ ì—†ì„ë•Œ ì²˜ë¦¬
            return "redirect:/";
        }
        model.addAttribute("registerItems",registerItems);
        return "item/registerItems";
    }
```

- GET : /item/items/{memberId}
  - memberIdë¡œ itemRepositoryì— ì €ì¥ëœ ëª¨ë“  ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
  - ë§Œì•½ registerItemì´ ì—†ë‹¤ë©´ í™ˆìœ¼ë¡œ redirectë¥¼ í•œë‹¤.
    - ìˆ˜ì • í•„ìš”í•˜ë‹¤. ë“±ë¡ì„í•˜ë ¤ë©´ registerItems.htmlì— ì ‘ê·¼í•´ì•¼í•˜ëŠ”ë° ì ‘ê·¼í•˜ì§€ ëª»í•œë‹¤.
  - modelì— ì°¾ì€ ë¦¬ìŠ¤íŠ¸ë¥¼ ë„˜ê¸°ê³  registerItems.htmlì„ ë¦¬í„´í•œë‹¤.


#### 3. DBInterface(jdbc)
```java
    public List<Item> findBySellerId(Long memberId){
        String sql = "select * from item where seller_id = ?";
        List<Item> itemList = new ArrayList<>();

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,memberId);
            rs = pstmt.executeQuery();
            while (rs.next()){
                Item item = new Item(
                        rs.getLong("seller_id"),
                        rs.getString("item_name"),
                        rs.getInt("item_price"),
                        rs.getInt("item_quantity"),
                        rs.getString("item_description"));
                item.setItemId(rs.getLong("item_id"));
                item.setSalesRate(rs.getInt("salesrate"));
                log.debug("itemRepo findByMemberId item={}",item);
                itemList.add(item);
                if (rs.isLast()){
                    log.debug("itemRepo findByMemberId itemList={}",itemList);
                    return itemList;
                }
            }
            throw new NoSuchFieldException();
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }
    }

```
- findBySellerId(Long memberId)
  - item í…Œì´ë¸”ì—ì„œ seller_id ê°€ memberIdì¸ ëª¨ë“  ì»¬ëŸ¼ì„ ê°€ì ¸ì™€ì„œ List<item>í˜•íƒœë¡œ ë¦¬í„´í•œë‹¤. ë§Œì•½ ì—†ë‹¤ë©´ ì˜ˆì™¸ë¥¼ í„°íŠ¸ë¦¬ê³  ë°”ë¡œ ì¡ì•„ì„œ nullì²˜ë¦¬í•œë‹¤.
    ```sql
      select * from item where seller_id = ? (memberId)
    ```




### ìƒí’ˆ ì¡°íšŒ(ë‚´ê°€ êµ¬ë§¤í•œ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸)

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/item/purchaseList.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/purchaseList.png?raw=true">

- ì´ì œê¹Œì§€ êµ¬ë§¤í•œ ìƒí’ˆëª©ë¡ì„ ë³´ì—¬ì£¼ëŠ” í™”ë©´ì´ë‹¤.
- url : /item/shoplist/{memberId}

#### 2. ì»¨íŠ¸ë¡¤ëŸ¬ ë¶€ë¶„ (controller)
```java
    @GetMapping("/shoplist/{memberId}")
    public String shopList(@PathVariable Long memberId, Model model){
        List<Item> shopList = reviewRepository.findByMemberId(memberId);
        if (shopList==null){
            return "redirect:/";
        }
        model.addAttribute("shopList",shopList);
        return "item/purchaseList";
    }
```

- GET : /item/shoplist/{memberId}
  - memberIdë¡œ reviewRepositoryì—ì„œ findByMemberId ë©”ì„œë“œë¥¼ í†µí•´ List<item>ì„ ë°˜í™˜ë°›ëŠ”ë‹¤.
    - listê°€ nullì¼ì‹œ homepageë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•œë‹¤.
    - ëª¨ë¸ì— ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹´ì•„ì„œ item/purchaselist.html ì„ ë¦¬í„´í•œë‹¤.


#### 3. DBInterface(jdbc)
```java
    public List<Item> findByMemberId(Long memberId){
        String sql = "select * from Item LEFT JOIN Review ON Item.item_id = Review.item_id where Review.buyer_id = ?";
        List<Item> itemList = new ArrayList<>();

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,memberId);
            rs = pstmt.executeQuery();
            while (rs.next()){
                Item item = new Item(
                        rs.getLong("seller_id"),
                        rs.getString("item_name"),
                        rs.getInt("item_price"),
                        rs.getInt("item_quantity"),
                        rs.getString("item_description"));
                item.setItemId(rs.getLong("item_id"));
                log.debug("itemRepo findByMemberId item={}",item);
                itemList.add(item);
                if (rs.isLast()){
                    log.debug("itemRepo findByMemberId itemList={}",itemList);
                    return itemList;
                }
            }
            throw new NoSuchFieldException();
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }
    }
```
**reviewRepository**
- findByMemberId(Long memberId)
  - join ì—°ì‚°ì„ í†µí•´ review tableì— buyer_id=memberId ì¸ item tableì˜ ì»¬ëŸ¼ì„ ê°€ì ¸ì™€ì„œ list<item>ì˜ ê°ì²´ë¡œ ë°˜í™˜í•œë‹¤.
    ```sql
      select * from Item LEFT JOIN Review ON Item.item_id = Review.item_id where Review.buyer_id = ?
    ```


---

## 4. ì¥ë°”êµ¬ë‹ˆ ê¸°ëŠ¥

### ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒ

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/member/basket.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/basket.png?raw=true">

- ì¥ë°”êµ¬ë‹ˆì— ë„£ì€ ëª©ë¡ì„ ì¡°íšŒí•˜ëŠ” í™”ë©´ì´ë‹¤.
- url : /item/basket/{memberId}

#### 2. ì»¨íŠ¸ë¡¤ëŸ¬ ë¶€ë¶„ (controller)
```java
    @GetMapping("/{memberId}")
    public String basket(@PathVariable Long memberId, Model model,
                         @ModelAttribute("basketForm")BasketForm basketForm){
        List<Item> basketItems = basketRepository.findByMemberId(memberId);
        model.addAttribute("basketItems",basketItems);
        return "/item/basket";
    }
```

- GET : /item/basket/{memberId}
  - memberIdë¥¼ í†µí•´ basketRepositoryì—ì„œ basketItems ë¦¬ìŠ¤íŠ¸ë¥¼ ë°›ì•„ì„œ /item/basket.htmlë¥¼ ë¦¬í„´í•œë‹¤.

#### 3. DTO
```java
@Data
public class BasketForm {
    private String[] basketItemIds;
}
```
- ì²´í¬ ë°•ìŠ¤ê°€ ì²´í¬ëœ itemì„ ì„œë²„ë‹¨(controller)ë¡œ ë°›ê³  ì‹¶ê¸° ë•Œë¬¸ì— String ë°°ì—´ë¡œ ì„ ì–¸í•˜ì—¬ ë¬¸ì idë¦¬ìŠ¤íŠ¸ë¥¼ ë°›ì•„ì˜¨ë‹¤.
#### 4. DBInterface(jdbc)
```java
    public List<Item> findByMemberId(Long memberId){
        String sql = "select * from Item LEFT JOIN Basket ON Item.item_id = Basket.item_id where Basket.member_id = ?";
        List<Item> itemList = new ArrayList<>();

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,memberId);
            rs = pstmt.executeQuery();
            while (rs.next()){
                Item item = new Item(
                        rs.getLong("member_id"),
                        rs.getString("item_name"),
                        rs.getInt("item_price"),
                        rs.getInt("item_quantity"),
                        rs.getString("item_description"));
                item.setItemId(rs.getLong("item_id"));
                log.debug("itemRepo findByMemberId item={}",item);
                itemList.add(item);
                if (rs.isLast()){
                    log.debug("itemRepo findByMemberId itemList={}",itemList);
                    return itemList;
                }
            }
            throw new NoSuchFieldException();
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }
    }

```
**basketRepository**
- findByMemberId(Long memberId)
  - item í…Œì´ë¸”ê³¼ basket í…Œì´ë¸” ì„ ì¡°ì¸ í•˜ì—¬ basketì´ memberIdì¸ item ì»¬ëŸ¼ë“¤ì„ ê°€ì ¸ì™€ì„œ list<item>ì˜ ê°ì²´ë¡œ ë¦¬í„´í•œë‹¤.
    ```sql
      select * from Item LEFT JOIN Basket ON Item.item_id = Basket.item_id where Basket.member_id = ?
    ```

### ì¥ë°”êµ¬ë‹ˆ ë“±ë¡

#### 1. ì»¨íŠ¸ë¡¤ëŸ¬ ë¶€ë¶„ (controller)
```java
    @GetMapping("/item/basket/{memberId}/{itemId}/add")
    public String addBasket(@PathVariable("memberId") Long memberId,
                            @PathVariable("itemId") Long itemId){
        if (basketRepository.find(itemId,memberId)!=null){
            return "redirect:/";
        }
        basketRepository.addBasket(itemId,memberId);
        return "redirect:/item/basket/{memberId}";
    }
```

- GET : /item/basket/{memberId}/{itemId}/add
  - ì´ë¯¸ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¨ìˆëŠ” ì•„ì´í…œì€ ë‹´ì•„ì§€ì§€ ì•Šê²Œí•˜ê¸° ìœ„í•´ì„œ itemId,memberId ë¡œ ì°¾ì•„ì§€ëŠ” ì•„ì´í…œì´ ìˆì„ê²½ìš°ëŠ” í™ˆí™”ë©´ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•œë‹¤.
  - ì¥ë°”êµ¬ë‹ˆ ë ˆí¬ì§€í† ë¦¬ì— ì¶”ê°€í•˜ê³  /item/basket/{memberId}(ë‚´ ì¥ë°”êµ¬ë‹ˆ ëª©ë¡)ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•œë‹¤

#### 2. DBInterface(jdbc)
```java
    public void addBasket(Long itemId, Long memberId){
        String sql = "insert into Basket(member_id,item_id) values (?,?)";

        Connection con = null;
        PreparedStatement pstmt = null;
        try{
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,memberId);
            pstmt.setLong(2,itemId);
            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }
```
**basketRepository**
- addBasket(Long itemId, Long memberId)
  - itemId, memberId ë¥¼ ë°›ì•„ì„œ insert ì¿¼ë¦¬ë¥¼ ë‚ ë¦°ë‹¤.
    ```sql
      insert into Basket(member_id,item_id) values (?,?)
    ```


### ì¥ë°”êµ¬ë‹ˆ ì‚­ì œ

#### 1. ì»¨íŠ¸ë¡¤ëŸ¬ ë¶€ë¶„ (controller)
```java
    @PostMapping("/{memberId}/basket")
    public String outBasket(@ModelAttribute("basketForm") BasketForm basketForm, BindingResult  bindingResult,
                            @PathVariable Long memberId){
        if (basketForm.getBasketItemIds().length==0){
            bindingResult.reject("NoCheckItem",null,"ì•„ë¬´ê²ƒë„ ì²´í¬í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        }
        for (String StringId : basketForm.getBasketItemIds()) {
            long itemId = Long.parseLong(StringId);
            basketRepository.delete(itemId,memberId);
        }
        return "redirect:/item/basket/{memberId}";
    }
```

- POST : /item/basket/{memberId}/basket
  - basketFormì—ì„œ ì²´í¬ëœ ì•„ì´í…œì„ ê°€ì ¸ì˜¨ë‹¤. string ë°°ì—´ì¸ idsë¥¼ ê°€ì ¸ì™€ì„œ itemid,memberIdë¥¼ basketRepository ì—ì„œ ì‚­ì œí•œë‹¤. 

#### 2. DBInterface(jdbc)
```java
    public void delete(Long itemId, Long memberId){
        String sql = "delete from basket where member_id=? and item_id=?;";
        Connection con = null;
        PreparedStatement pstmt = null;
        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setLong(1,memberId);
            pstmt.setLong(2,itemId);
            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con, pstmt, null);
        }
    }
```
**basketRepository**
- delete(Long itemId, Long memberId)
  - basket í…Œì´ë¸”ì—ì„œ member_id = memberId, item_id = itemId ì¸ ê°’ì„ deleteí•œë‹¤.
    ```sql
      delete from basket where member_id=? and item_id=?;
    ```

### ì¥ë°”êµ¬ë‹ˆ êµ¬ë§¤


#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/item/purchase.html)

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/purchase.png?raw=true">

- íšŒì› ì •ë³´ë¥¼ ìˆ˜ì •í•˜ëŠ” í™”ë©´ì´ë‹¤.
- url : /item/basket/{memberId}/purchase

#### 2. ì»¨íŠ¸ë¡¤ëŸ¬ ë¶€ë¶„ (controller)
```java
    @PostMapping("/{memberId}/purchase")
    public String purchase(@ModelAttribute("basketForm") BasketForm basketForm,
                           @ModelAttribute("purchaseForm") PurchaseForm purchaseForm,
                           @PathVariable Long memberId,
                           Model model
                           ){
        List<Item> purchaseList = new ArrayList<>();
        Integer resultPrice = 0;
        for (String StringId : basketForm.getBasketItemIds()) {
            long itemId = Long.parseLong(StringId);
            Item item = itemRepository.find(itemId);
            resultPrice = resultPrice + item.getPrice();
            purchaseList.add(item);
        }
        if (purchaseList==null){
            return "redirect:/item/basket/{memberId}";
        }
        model.addAttribute("purchaseList",purchaseList);
        purchaseForm.setResultPrice(resultPrice);
        purchaseForm.setPurchaseItemIds(basketForm.getBasketItemIds());
        return "/item/purchase";
    }
```

- POST :  /item/basket/{memberId}/purchase
  - basketFormì— ë“¤ì–´ì˜¨ idsë¥¼ í†µí•´ itemì„ ì°¾ëŠ”ë‹¤.
  - ëª¨ë“  itemì˜ ê°€ê²©ì„ ë”í•œ í›„ PurchaseFormì˜ resultPriceì— ì €ì¥í•œë‹¤.
  - getBasketItemIdsë¥¼ PurchaseFormì˜ purchaseItemIdsì— ì €ì¥í•œë‹¤.
  - ëª¨ë¸ì— purchaseListë¥¼ ë‹´ëŠ”ë‹¤.
  - /item/purchase.htmlì„ ë¦¬í„´í•œë‹¤.

#### 3. DTO
```java
@Data
public class PurchaseForm {
    String[] purchaseItemIds;
    Integer resultPrice;
}
```
- purchaseItemIds : ì¥ë°”êµ¬ë‹ˆì—ì„œ ì²´í¬ëœ ëª©ë¡ì„ ê·¸ëŒ€ë¡œ ë°›ì•„ì˜¤ê¸° ìœ„í•´ì„œ string[]ë¡œ ì„ ì–¸í•œë‹¤.
- resultPrice : ëª¨ë“  ì•„ì´í…œì˜ ì´ ê°€ê²©ì„ ë³´ì—¬ì£¼ê¸°ìœ„í•œ ë³€ìˆ˜ì´ë‹¤.

---

## 5. ì›¹ ë¨¸ë‹ˆ ê¸°ëŠ¥

### ìƒí’ˆ êµ¬ë§¤ í”„ë¡œì„¸ìŠ¤

#### 1. ì»¨íŠ¸ë¡¤ëŸ¬ ë¶€ë¶„ (controller)
```java
@Slf4j
@Controller
@RequiredArgsConstructor
@RequestMapping("/item/purchase")
public class PurchaseController {
    private final ItemRepository itemRepository;
    private final ReviewRepository reviewRepository;
    private final MemberRepository memberRepository;
    private final BasketRepository basketRepository;

    @GetMapping("/{memberId}/{itemId}")
    public String purchasePage(
            @ModelAttribute("purchaseForm") PurchaseForm purchaseForm,
            @PathVariable Long itemId,
            @PathVariable Long memberId,
            Model model
    ){
        Item item = itemRepository.find(itemId);
        List<Item> purchaseList = new ArrayList<>();
        purchaseList.add(item);
        model.addAttribute("purchaseList",purchaseList);

        String[] ids = new String[1];
        ids[0] = String.valueOf(itemId);
        purchaseForm.setPurchaseItemIds(ids);
        purchaseForm.setResultPrice(item.getPrice());
        return "/item/purchase";
    }

    @PostMapping("/{memberId}")
    public String purchase(
            @ModelAttribute("purchaseForm") PurchaseForm purchaseForm,
            BindingResult bindingResult,
            @PathVariable Long memberId
    ){
        Member member = memberRepository.find(memberId);
        String[] purchaseItemIds = purchaseForm.getPurchaseItemIds();
        if (purchaseItemIds==null){
            bindingResult.reject("purchaseItemIds","êµ¬ë§¤ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.");
        }
        if (purchaseForm.getResultPrice()>member.getMoney()){
            bindingResult.rejectValue("resultPrice","resultPrice","ê²Œì„ ë¨¸ë‹ˆê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ì¶©ì „ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        }
        if (bindingResult.hasErrors()){
            return "/item/purchase";
        }


        //service
        for (String itemId : purchaseItemIds) {
            long id = Long.parseLong(itemId);
            Item item = itemRepository.find(id);
            if (item.getQuantity()==0){
                bindingResult.reject("noItem",null,"ì‚¬ë ¤ê³  í•˜ëŠ” ë¬¼í’ˆ ì¤‘ì— ì¬ê³ ê°€ ì—†ëŠ” ë¬¼ê±´ì´ ìˆìŠµë‹ˆë‹¤.");
                return "/item/purchase";
            }
            Member sellerMember = memberRepository.find(item.getSellerId());
            sellerMember.setMoney(sellerMember.getMoney()+item.getPrice());
            member.setMoney(member.getMoney()-item.getPrice());
            memberRepository.updateMoney(sellerMember);
            memberRepository.updateMoney(member);
            Integer salesRate = item.getSalesRate() + 1;
            int quantity = item.getQuantity() - 1;
            item.setQuantity(quantity);
            item.setSalesRate(salesRate);
            itemRepository.update(item);
            reviewRepository.addPurchaseList(item.getItemId(),memberId);
            basketRepository.delete(item.getItemId(),memberId);


        }
        return "redirect:/item/shoplist/{memberId}";

    }
}
```

- GET : /item/purchase/{memberId}/{itemId}
  - purchase.htmlì—ì„œ PurchaseFormê°€ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— itemIdë¥¼ string[]ë¡œ ë‹´ì•„ì„œ PurchaseFormìœ¼ë¡œ ì €ì¥í•œë‹¤.
- POST : /item/purchase/{memberId}
  - memberIdë¥¼ í†µí•´ memberë¥¼ ì°¾ëŠ”ë‹¤.
  - purchaseForm.getPurchaseItemIds() nullì¼ë•Œ bindingresultì— ì˜¤ë¥˜ë¥¼ ì €ì¥í•œë‹¤.
  - ì„œë¹„ìŠ¤ ë¡œì§ì„ ìˆ˜í–‰í•œ ë’¤ /item/shoplist/{memberId}(êµ¬ë§¤ ëª©ë¡)ì„ ë¦¬ë‹¤ì´ë ‰íŠ¸í•œë‹¤.
  
#### 3. ì„œë¹„ìŠ¤ ë¶€ë¶„(service)
```java
        for (String itemId : purchaseItemIds) {
            long id = Long.parseLong(itemId);
            Item item = itemRepository.find(id);
            if (item.getQuantity()==0){
                bindingResult.reject("noItem",null,"ì‚¬ë ¤ê³  í•˜ëŠ” ë¬¼í’ˆ ì¤‘ì— ì¬ê³ ê°€ ì—†ëŠ” ë¬¼ê±´ì´ ìˆìŠµë‹ˆë‹¤.");
                return "/item/purchase";
            }
            Member sellerMember = memberRepository.find(item.getSellerId());
            sellerMember.setMoney(sellerMember.getMoney()+item.getPrice());
            member.setMoney(member.getMoney()-item.getPrice());
            memberRepository.updateMoney(sellerMember);
            memberRepository.updateMoney(member);
            Integer salesRate = item.getSalesRate() + 1;
            int quantity = item.getQuantity() - 1;
            item.setQuantity(quantity);
            item.setSalesRate(salesRate);
            itemRepository.update(item);
            reviewRepository.addPurchaseList(item.getItemId(),memberId);
            basketRepository.delete(item.getItemId(),memberId);
```
1. itemì—ì„œ íŒë§¤ì idë¥¼ ê°€ì ¸ì™€ì„œ íŒë§¤ì member ê°ì²´ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
2. ì´í›„ íŒë§¤ì member.moneyì— ì•„ì´í…œê°€ê²©ì„ ë”í•œë‹¤.
3. êµ¬ë§¤ì member.moneyì—ëŠ” ì•„ì´í…œ ê°€ê²©ì„ ëº€ë‹¤.
4. ë‘ ë§´ë²„ ê°ì²´ ë‹¤ memberRepositoryì—ì„œ updateë¥¼ í•´ì¤€ë‹¤.
5. itemì˜ salesReate(íŒë§¤ëŸ‰)ì„ 1 ì˜¬ë¦°ë‹¤.
6. itemì˜ quantityë¥¼ 1 ë‚´ë¦°ë‹¤.
7. itemRepositoryì—ì„œ updateí•´ì¤€ë‹¤.
8. reviewRepositoryì— add í•´ì¤€ë‹¤. (ì•„ì´í…œid,êµ¬ë§¤ìid)
9. ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ì—ì„œ ì‚­ì œí•œë‹¤.

### ì›¹ ë¨¸ë‹ˆ ì¶©ì „

#### 1. ì¶©ì „ íŒì—…ì„ ë›°ìš´ë’¤ ì§„í–‰ í”„ë¡œì„¸ìŠ¤


<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/money1.png?raw=true">
<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/money2.png?raw=true">
<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/money3.png?raw=true">
<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/money4.png?raw=true">
<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/money5.png?raw=true">

- íšŒì› ì •ë³´ì—ì„œ ì›¹ ë¨¸ë‹ˆ ì¶©ì „ íŒì—…ì„ ë›°ìš´ë’¤ ì§„í–‰ëœë‹¤..

#### 2. ì»¨íŠ¸ë¡¤ëŸ¬ ë¶€ë¶„ (controller)
```java
    @GetMapping("/charge/verify/{memberId}")
    public String chargeVerify(@ModelAttribute("findMember") FindMemberForm findMemberForm){
        return "member/charge/cashVerify";
    }
    @PostMapping("/charge/verify/{memberId}")
    public String chargeVerify(@Valid @ModelAttribute("findMember") FindMemberForm findMemberForm,
                               BindingResult bindingResult,
                               @PathVariable Long memberId,
                               Model model
                               ){
        if (bindingResult.hasErrors()){
            return "member/charge/cashVerify";
        }

        Member member = memberRepository.find(memberId);

        if (member!=null&&memberService.isMember(findMemberForm, member)){
            //ì„±ê³µë¡œì§
            model.addAttribute("member",member);
            return "member/charge/verifyDone";
        }
        //ì‹¤íŒ¨ë¡œì§
        bindingResult.rejectValue("email","emailError","í•´ë‹¹ ì •ë³´ì™€ ì¼ì¹˜í•˜ëŠ” íšŒì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return "member/charge/cashVerify";
    }
    @GetMapping("/charge/input/{memberId}")
    public String chargeInput(@ModelAttribute("inputMoney")ChargeCashForm cashForm,
                              @PathVariable Long memberId, Model model){
        Member member = memberRepository.find(memberId);
        model.addAttribute("member",member);
        return "member/charge/cashCharge";
    }
    @PostMapping("/charge/input/{memberId}")
    public String chargeInput(@Valid @ModelAttribute("inputMoney")ChargeCashForm cashForm, BindingResult bindingResult,
                              @PathVariable Long memberId, Model model){
        Member member = memberRepository.find(memberId);
        if (bindingResult.hasErrors()){
            model.addAttribute("member",member);
            return "member/charge/cashCharge";
        }
        Member updateMember = memberService.chargeCash(member, cashForm);
        memberRepository.updateMoney(updateMember);
        return "member/charge/chargeDone";
    }
```
#### 3. DBInterface(jdbc)
```java
    public void update(Member member){
        String sql = "update member set (member_name, member_email, member_password) = (?,?,?) where member_id=?";

        Connection con = null;
        PreparedStatement pstmt = null;
        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1,member.getName());
            pstmt.setString(2,member.getEmail());
            pstmt.setString(3,member.getPassword());
            pstmt.setLong(4,member.getId());

            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,null);
        }
    }
```

## 6. í™ˆ í™”ë©´

<img src="https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/docs/ver1/img/home.png?raw=true">


### ì¸ê¸° ìƒí’ˆ

#### 1. [html(thymeleaf)](https://github.com/gudals-kim/web_vulnerability/blob/delevlop/web/src/main/resources/templates/loginhome.html)

- ë©”ì¸í™”ë©´ì˜ ìƒë‹¨ ì¸ê¸° íŒë§¤ ë°°ë„ˆì´ë‹¤.
- url : /

#### 2. ì»¨íŠ¸ë¡¤ëŸ¬ ë¶€ë¶„ (controller)
```java

@Slf4j
@Controller
@RequiredArgsConstructor
public class HomeController {
    private final ItemRepository itemRepository;

    @GetMapping("/")
    public String homeLogin(
            @Login Member loginMember, Model model
            ) {
        List<Item> items = itemRepository.findAll();
        List<Item> popularItems = itemRepository.findPopularItems();
        log.debug("items={}",items);
        model.addAttribute("popularItems",popularItems);
        model.addAttribute("items",items);
        log.debug("loginMember={}",loginMember);
        //ë¡œê·¸ì¸
        if (loginMember == null){
            return "home";
        }
        //ì„¸ì…˜ì´ ìœ ì§€ë˜ë©´ ë¡œê·¸ì¸ ì´ë™
        model.addAttribute("member", loginMember);
        return "loginHome";
    }

}
```

- GET :  /
  - ëª¨ë“  ì•„ì´í…œì„ ì°¾ì•„ ë¦¬ìŠ¤íŠ¸ë¡œ ë°›ëŠ”ë‹¤. itemRepository.finAll
  - íŒë§¤ëŸ‰ top 3ê°œë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ë°›ëŠ”ë‹¤. itemRepository.findPopularItems()
  - modelì— ì €ì¥í•œë‹¤.
  - loginMemberê°€ nullì´ë©´ home.htmlì„ ë¦¬í„´í•œë‹¤.
  - loginMember ê°ì²´ê°€ ìˆì„ì‹œ modelì— ì €ì¥í›„ loginHome.htmlì„ ë¦¬í„´í•œë‹¤.


#### 3. DBInterface(jdbc)
```java
    public List<Item> findAll() {
        String sql = "select * from item ORDER BY salesrate DESC";
        List<Item> itemList = new ArrayList<>();
        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            rs = pstmt.executeQuery();
            while (rs.next()) {
                Item item = new Item(
                        rs.getLong("seller_id"),
                        rs.getString("item_name"),
                        rs.getInt("item_price"),
                        rs.getInt("item_quantity"),
                        rs.getString("item_description"));
                item.setItemId(rs.getLong("item_id"));
                item.setSalesRate(rs.getInt("salesrate"));
                log.debug("itemRepo findAll item={}", item);
                itemList.add(item);
                if (rs.isLast()){
                    log.debug("itemRepo findAll itemList={}",itemList);
                    return itemList;
                }
            }
            throw new NoSuchFieldException();
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con, pstmt, rs);
        }
    }




    public List<Item> findPopularItems(){
        String sql = "SELECT * FROM (select * from item ORDER BY salesrate DESC) WHERE ROWNUM <=3 ;";
        List<Item> itemList = new ArrayList<>();

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            rs = pstmt.executeQuery();
            while (rs.next()){
                Item item = new Item(
                        rs.getLong("seller_id"),
                        rs.getString("item_name"),
                        rs.getInt("item_price"),
                        rs.getInt("item_quantity"),
                        rs.getString("item_description"));
                item.setItemId(rs.getLong("item_id"));
                item.setSalesRate(rs.getInt("salesrate"));
                log.debug("itemRepo findByMemberId item={}",item);
                itemList.add(item);
                if (rs.isLast()){
                    log.debug("itemRepo findByMemberId itemList={}",itemList);
                    return itemList;
                }
            }
            throw new NoSuchFieldException();
        } catch (SQLException | NoSuchFieldException e) {
            if (e instanceof NoSuchFieldException){
                return null;
            }
            throw new RuntimeException(e);
        } finally {
            close(con,pstmt,rs);
        }
    }
```
**itemRepository**
- findAll()
  - item í…Œì´ë¸”ì—ì„œ salesrate(íŒë§¤ëŸ‰) ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬í•˜ì—¬ ëª¨ë“  ì»¬ëŸ¼ì„ ê°€ì ¸ì˜¨ë‹¤.
  - ì´í›„ itemê°ì²´ë¡œ ë°”ë€ë’¤ Listì— ë‹´ì•„ ë¦¬í„´í•œë‹¤.
    ```sql
      select * from item ORDER BY salesrate DESC;
    ```
- findPopularItems()
  - item í…Œì´ë¸”ì—ì„œ salesrate(íŒë§¤ëŸ‰) ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ í›„ ìƒìœ„ 3ê°œë§Œ ê°€ì ¸ì˜¨ë‹¤.
  - ì´í›„ ì»¬ëŸ¼ ì •ë³´ë¥¼ item ê°ì²´ì— ë§¤í•‘ í•œë’¤ listì— ë‹´ì•„ ë¦¬í„´í•œë‹¤.
    ```sql
      SELECT * FROM (select * from item ORDER BY salesrate DESC) WHERE ROWNUM <=3 ;
    ```